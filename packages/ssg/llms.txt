// Combined source for @kirejs/ssg

// --- From: packages/ssg/src/index.ts ---
import { mkdir, readdir, writeFile } from "node:fs/promises";
import { watch } from "node:fs";
import { createServer, type ServerResponse } from "node:http";
import { dirname, join, relative, resolve } from "node:path";
import { glob } from "glob";
import type { Kire, KirePlugin } from "kire";
import type { KireAsset } from "@kirejs/assets";
import { renderErrorPage } from "./error-page";

declare module "kire" {
	interface Kire {
		parseMarkdown?(content: string): Promise<string>;
	}
}

// Singleton instance to hold Kire reference
let kireInstance: Kire | null = null;
let assetsPrefix = "_kire";

interface SsgOptions {
	assetsPrefix?: string;
}

interface BuildOptions {
	out: string;
	dir?: string; // Source directory relative to root, defaults to root
}

// Track file access for debugging
const fileAccessHistory: Array<{
	file: string;
	timestamp: Date;
	type: 'read' | 'write' | 'compile' | 'cache';
	duration?: number;
}> = [];

// Track route compilation chain
const routeCompilationChain: Map<string, string[]> = new Map();
let currentRoute: string | null = null;

// Create a proxy to track file accesses
function trackFileAccess(kire: Kire) {
	const originalCacheGet = kire.$files.get;
	const originalCacheSet = kire.$files.set;
	const originalCacheClear = kire.$files.clear;
	
	kire.$files.get = function(key: string) {
		const start = Date.now();
		const result = originalCacheGet.call(this, key);
		const duration = Date.now() - start;
		
		fileAccessHistory.push({
			file: key,
			timestamp: new Date(),
			type: 'cache',
			duration
		});
		
		// Track in compilation chain if we're processing a route
		if (currentRoute && !routeCompilationChain.has(currentRoute)) {
			routeCompilationChain.set(currentRoute, []);
		}
		if (currentRoute && !routeCompilationChain.get(currentRoute)?.includes(key)) {
			routeCompilationChain.get(currentRoute)?.push(key);
		}
		
		return result;
	};
	
	kire.$files.set = function(key: string, value: any) {
		fileAccessHistory.push({
			file: key,
			timestamp: new Date(),
			type: 'write'
		});
		return originalCacheSet.call(this, key, value);
	};
	
	kire.$files.clear = function() {
		fileAccessHistory.length = 0; // Clear history on cache clear
		routeCompilationChain.clear();
		return originalCacheClear.call(this);
	};
	
	// Track view compilation
	const originalView = kire.view.bind(kire);
	kire.view = async (template: string, data?: any) => {
		const prevRoute = currentRoute;
		currentRoute = template;
		const start = Date.now();
		
		try {
			fileAccessHistory.push({
				file: template,
				timestamp: new Date(),
				type: 'compile'
			});
			
			// Initialize chain for this route
			routeCompilationChain.set(template, [template]);
			
			const result = await originalView(template, data);
			const duration = Date.now() - start;
			
			// Update last entry with duration
			const lastEntry = fileAccessHistory[fileAccessHistory.length - 1];
			if (lastEntry && lastEntry.file === template) {
				lastEntry.duration = duration;
			}
			
			return result;
		} finally {
			currentRoute = prevRoute;
		}
	};
}

export const KireSsg: KirePlugin<SsgOptions> & {
	build: (opts: BuildOptions) => Promise<void>;
	dev: (opts?: { port?: number }) => Promise<void>;
	getFileAccessHistory: () => typeof fileAccessHistory;
	getRouteCompilationChain: () => Map<string, string[]>;
} = {
	name: "@kirejs/ssg",
	options: {},
	load(kire: Kire, opts) {
		kireInstance = kire;
		if (opts?.assetsPrefix) {
			assetsPrefix = opts.assetsPrefix.replace(/^\//, "").replace(/\/$/, "");
		}
		
		// Track file accesses
		trackFileAccess(kire);
	},

	async build(opts: BuildOptions) {
		if (!kireInstance)
			throw new Error(
				"KireSsg plugin not registered or Kire instance not ready.",
			);

		const outDir = resolve(opts.out);
		const rootDir = resolve(kireInstance.root);

		console.log(`Building to ${outDir}...`);

		await mkdir(outDir, { recursive: true });

		// Helper to crawl
		async function getFiles(dir: string): Promise<string[]> {
			const dirents = await readdir(dir, { withFileTypes: true });
			const files = await Promise.all(
				dirents.map(async (dirent) => {
					const res = resolve(dir, dirent.name);
					if (dirent.isDirectory()) {
						return getFiles(res);
					} else {
						return res;
					}
				}),
			);
			return Array.prototype.concat(...files);
		}

		const allFiles = await getFiles(rootDir);
		const ext = kireInstance.extension.startsWith(".")
			? kireInstance.extension
			: `.${kireInstance.extension}`;

		const templateFiles = allFiles.filter((f) => f.endsWith(ext));

		for (const file of templateFiles) {
			const relativePath = relative(rootDir, file);
			if (relativePath.split("/").some((p) => p.startsWith("_"))) continue;

			try {
				// Clear tracking for this build
				fileAccessHistory.length = 0;
				routeCompilationChain.clear();
				
				// 1. Render the template to check for generator markers
				const html = await kireInstance.view(file, { currentPath: "" });

				// Check for marker
				const markerRegex = /<!-- KIRE_GEN:(.*?) -->/;
				const match = html.match(markerRegex);

				if (match) {
					const globPattern = match[1];
					console.log(
						`> Detected Generator in ${relativePath} for '${globPattern}'`,
					);

					// Find markdown files
					const mdFiles = await glob(globPattern!, { cwd: rootDir });

					for (const mdFile of mdFiles) {
						const mdRelative = String(mdFile);
						
						// Clear tracking for each generated page
						fileAccessHistory.length = 0;
						routeCompilationChain.clear();

						// Render template again with currentPath local
						const pageHtml = await kireInstance.view(file, {
							currentPath: mdRelative
						});

						// Remove the marker from final output
						const finalHtml = pageHtml.replace(match[0], "");

						// Output: dist/path/to/file.html
						const htmlOutPath = mdRelative.replace(/\.(md|markdown)$/, ".html");
						const fullOutPath = join(outDir, htmlOutPath);

						await mkdir(dirname(fullOutPath), { recursive: true });
						await writeFile(fullOutPath, finalHtml);
						console.log(`  -> Generated ${htmlOutPath}`);
						
						// Log compilation chain for this page
						const chain = routeCompilationChain.get(file);
						if (chain && chain.length > 0) {
							console.log(`  â”œâ”€ Compilation chain:`);
							chain.forEach((f, i) => {
								const prefix = i === chain.length - 1 ? 'â””â”€' : 'â”œâ”€';
								console.log(`  ${prefix} ${relative(rootDir, f)}`);
							});
						}
					}
				} else {
					// Normal file
					const htmlPath = relativePath.replace(
						new RegExp(`\\${ext}$`),
						".html",
					);
					const outPath = join(outDir, htmlPath);

					await mkdir(dirname(outPath), { recursive: true });
					await writeFile(outPath, html);
					console.log(`âœ“ ${htmlPath}`);
					
					// Log compilation chain
					const chain = routeCompilationChain.get(file);
					if (chain && chain.length > 0) {
						console.log(`  â””â”€ Dependencies: ${chain.length - 1} file(s)`);
						if (chain.length > 1) {
							console.log(`     Chain: ${chain.slice(1).map(f => relative(rootDir, f)).join(' â†’ ')}`);
						}
					}
				}
			} catch (e: any) {
				console.error(`âœ— Failed to render ${relativePath}:`, e.message);
				
				// Show compilation chain that led to error
				const chain = routeCompilationChain.get(file);
				if (chain && chain.length > 0) {
					console.error(`  Compilation chain that failed:`);
					chain.forEach((f, i) => {
						const prefix = i === chain.length - 1 ? 'â””â”€[ERROR]' : 'â”œâ”€';
						console.error(`  ${prefix} ${relative(rootDir, f)}`);
					});
				}
			}
		}

		// Write assets
		const assetsCache = kireInstance.cached<KireAsset>("@kirejs/assets");
		const entries = Array.from(assetsCache.entries());

		if (entries.length > 0) {
			const assetsDir = join(outDir, assetsPrefix);
			await mkdir(assetsDir, { recursive: true });

			for (const [hash, asset] of entries) {
				const filename = `${hash}.${asset.type === "css" ? "css" : asset.type === "mjs" ? "mjs" : "js"}`;
				await writeFile(join(assetsDir, filename), asset.content);
				console.log(`âœ“ Asset: ${assetsPrefix}/${filename}`);
			}
		}

		console.log("Build complete.");
		
		// Print summary of file accesses
		console.log("\nðŸ“Š File Access Summary:");
		const uniqueFiles = new Set(fileAccessHistory.map(f => f.file));
		console.log(`Total unique files accessed: ${uniqueFiles.size}`);
		console.log(`Total file operations: ${fileAccessHistory.length}`);
		
		// Group by type
		const byType = fileAccessHistory.reduce((acc, curr) => {
			acc[curr.type] = (acc[curr.type] || 0) + 1;
			return acc;
		}, {} as Record<string, number>);
		
		Object.entries(byType).forEach(([type, count]) => {
			console.log(`  ${type}: ${count}`);
		});
	},

	async dev(opts = {}) {
		if (!kireInstance) throw new Error("KireSsg plugin not registered.");

		const port = opts.port || 3000;
		const clients: ServerResponse[] = [];
		const rootDir = resolve(kireInstance.root);

		// File Watcher
		let fsWait: Timer | boolean = false;
		watch(rootDir, { recursive: true }, (_event, filename) => {
			if (filename) {
				if (fsWait) return;
				fsWait = setTimeout(() => {
					fsWait = false;
				}, 100);

				console.log(`[DEV] File changed: ${filename}. Reloading clients...`);
				// Clear cache to ensure fresh render
				kireInstance!.cacheClear();

				// Notify clients
				clients.forEach(res => {
					res.write(`data: reload\n\n`);
				});
			}
		});

		const server = createServer(async (req, res) => {
			const url = req.url || "/";

			// SSE Endpoint
			if (url === "/kire-livereload") {
				res.writeHead(200, {
					"Content-Type": "text/event-stream",
					"Cache-Control": "no-cache",
					"Connection": "keep-alive",
				});
				res.write("data: connected\n\n");
				clients.push(res);

				req.on("close", () => {
					const idx = clients.indexOf(res);
					if (idx !== -1) clients.splice(idx, 1);
				});
				return;
			}

			console.log(`[DEV] Request: ${req.method} ${url}`);

			try {
				// Clear tracking for this request
				fileAccessHistory.length = 0;
				routeCompilationChain.clear();

				// Handle assets
				const prefixPath = `/${assetsPrefix}/`;
				if (url.startsWith(prefixPath)) {
					console.log(`[DEV] Attempting to serve asset: ${url}`);
					const match = url.match(/\/([a-f0-9]{8})\.(js|css|mjs)$/);
					if (match) {
						const hash = match[1];
						const ext = match[2] as "js" | "css" | "mjs";
						const assetsCache = kireInstance!.cached<KireAsset>("@kirejs/assets");
						const asset = assetsCache.get(hash!);
						if (asset && asset.type === ext) {
							res.setHeader(
								"Content-Type",
								ext === "css" ? "text/css" : "application/javascript",
							);
							res.end(asset.content);
							console.log(`[DEV] Served asset: ${url}`);
							return;
						}
					}
					// If match failed or asset not found in cache
					console.warn(`[DEV] Asset not found in cache: ${url}`);
					res.statusCode = 404;
					res.end("Asset Not Found");
					return;
				}

				// Handle pages
				let baseFilename = url === "/" ? "index" : url.substring(1);
				if (baseFilename.endsWith(".html"))
					baseFilename = baseFilename.slice(0, -5);

				const candidates = [
					baseFilename,
					`${baseFilename}/index`,
					`pages/${baseFilename}`,
					`pages/${baseFilename}/index`,
				];

				let html: string | null | undefined = null;
				let servedCandidate = "";

				for (const candidate of candidates) {
					try {
						html = await kireInstance?.view(candidate);
						servedCandidate = candidate;
						break;
					} catch (e: any) {
						if (
							e.message.includes("No resolver") ||
							e.message.includes("ENOENT") ||
							e.message.includes("Template not found")
						) {
							continue;
						}
						throw e; // Re-throw unexpected errors
					}
				}

				if (html !== null) {
					res.setHeader("Content-Type", "text/html");

					// Inject Live Reload Script
					const liveReloadScript = `
                        <script>
                            (() => {
                                const evtSource = new EventSource("/kire-livereload");
                                evtSource.onmessage = (event) => {
                                    if (event.data === "reload") {
                                        console.log("[Kire] Reloading...");
                                        window.location.reload();
                                    }
                                };
                                evtSource.onopen = () => console.log("[Kire] Live reload connected");
                                window.onbeforeunload = () => evtSource.close();
                            })();
                        </script>
                    `;

					if (html!.includes("</body>")) {
						html = html!.replace("</body>", `${liveReloadScript}</body>`);
					} else {
						html += liveReloadScript;
					}

					res.end(html);
					
					// Log compilation chain for this request
					console.log(`[DEV] âœ“ 200 ${url} -> ${servedCandidate}`);
					const chain = routeCompilationChain.get(servedCandidate);
					if (chain && chain.length > 1) {
						console.log(`[DEV]   â”œâ”€ Compilation chain (${chain.length} files):`);
						chain.slice(0, 5).forEach((file, i) => {
							const relPath = relative(rootDir, file);
							const prefix = i === chain.length - 1 || i === 4 ? 'â””â”€' : 'â”œâ”€';
							console.log(`[DEV]   ${prefix} ${relPath} ${i === 0 ? '(entry)' : ''}`);
						});
						if (chain.length > 5) {
							console.log(`[DEV]   â””â”€ ... and ${chain.length - 5} more files`);
						}
					}
				} else {
					const isNoise = url.includes("favicon.ico") || url.includes(".well-known") || url.includes(".map");
					if (!isNoise) {
						console.warn(
							`[DEV] âš  404 ${url}`,
						);
					}
					res.statusCode = 404;
					res.end(`Not Found: ${req.url}`);
				}
			} catch (e: any) {
				if (
					e.message.includes("No resolver") ||
					e.message.includes("ENOENT") ||
					e.message.includes("Template not found")
				) {
					const isNoise = req.url?.includes("favicon.ico") || req.url?.includes(".well-known");
					if (!isNoise) {
						console.warn(`[DEV] âš  404 ${req.url}`);
					}
					res.statusCode = 404;
					res.end(`Not Found: ${req.url}`);
				} else {
					console.error(`[DEV] âœ— 500 ${req.url}`);
					console.error(e);
					res.statusCode = 500;
					
					// Get cached files and compilation chain
					const cachedFiles = Array.from(kireInstance!.$files.keys());
					const chain = routeCompilationChain.get(currentRoute || '');
					
					const errorHtml = renderErrorPage({
						error: e,
						req,
						files: cachedFiles,
						kire: kireInstance!
					});
					
					// Log detailed compilation chain for debugging
					if (chain && chain.length > 0) {
						console.error(`[DEV]   Compilation chain that failed:`);
						chain.forEach((file, i) => {
							const relPath = relative(rootDir, file);
							const prefix = i === chain.length - 1 ? 'â””â”€[ERROR]' : 'â”œâ”€';
							console.error(`[DEV]   ${prefix} ${relPath} ${i === 0 ? '(entry)' : ''}`);
						});
						
						// Also show file access history
						console.error(`[DEV]   File access history (last 10):`);
						fileAccessHistory.slice(-10).forEach(access => {
							const relPath = relative(rootDir, access.file);
							console.error(`[DEV]     [${access.timestamp.toISOString().split('T')[1]!.slice(0, -1)}] ${access.type}: ${relPath} ${access.duration ? `(${access.duration}ms)` : ''}`);
						});
					}
					
					res.end(errorHtml);
				}
			}
		});

		server.listen(port, () => {
			console.log(`Server running at http://localhost:${port}`);
		});

		return new Promise(() => { });
	},
	
	// Expose tracking functions
	getFileAccessHistory() {
		return fileAccessHistory;
	},
	
	getRouteCompilationChain() {
		return routeCompilationChain;
	}
};

export default KireSsg;

// --- From: packages/ssg/src/error-page.ts ---
import type { IncomingMessage } from "node:http";
import type { Kire } from "kire";

export interface ErrorPageParams {
  error: any;
  req: IncomingMessage;
  files: string[];
  kire: Kire;
}

function escapeHtml(input: string): string {
  return input
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

export function renderErrorPage(params: ErrorPageParams): string {
  const { error, req, files, kire } = params;

  const errorTitle = escapeHtml(String(error?.message || "Internal Server Error"));
  const stack = escapeHtml(String(error?.stack || ""));
  const generatedCode = escapeHtml(String(error?.kireGeneratedCode || ""));
  const codeFrame = escapeHtml(String(error?.codeFrame || ""));
  const url = escapeHtml(String(req?.url || "/"));
  const method = escapeHtml(String((req as any)?.method || "GET"));

  // Get compilation chain from Kire instance (if available)
  const compilationChain: string[] = (kire as any).$compilationChain || [];

  const hasCodeFrame = Boolean(codeFrame && codeFrame.trim().length > 0);
  const hasGeneratedCode = Boolean(generatedCode && generatedCode.trim().length > 0);

  return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Error: ${errorTitle}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@iconify/iconify@3.0/dist/iconify.min.js"></script>
  <script>
    // Optional: small theme adjustments (no custom CSS)
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            mono: ["SFMono-Regular", "Consolas", "Liberation Mono", "Menlo", "monospace"],
            sans: ["-apple-system","BlinkMacSystemFont","Segoe UI","Roboto","sans-serif"]
          }
        }
      }
    };
  </script>
</head>

<body class="min-h-screen bg-zinc-900 text-slate-200 font-sans">
  <div class="mx-auto max-w-6xl px-5 py-8">
    <!-- Header -->
    <header class="relative mb-8 pl-10">
      <div class="absolute -left-10 -top-8 -z-10 select-none text-[160px] leading-none font-black text-red-500/10">500</div>

      <div class="flex items-center gap-2">
        <span class="text-xs font-semibold tracking-[0.2em] uppercase text-red-300/90">
          Kire Error
        </span>
        <span class="text-slate-500">â€¢</span>
        <span class="text-xs font-semibold tracking-[0.2em] uppercase text-slate-500">
          Internal Server Error
        </span>
      </div>

      <h1 class="mt-2 text-2xl sm:text-3xl font-bold text-white break-words">
        ${errorTitle}
      </h1>

      <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
        <span class="inline-flex items-center gap-2 rounded-md bg-sky-500/10 px-2.5 py-1 font-mono text-sky-300">
          <span class="text-sky-200/80">${method}</span>
          <span class="text-sky-300">${url}</span>
        </span>

        <span class="inline-flex items-center gap-2 rounded-md bg-slate-800 px-2.5 py-1 text-slate-300">
          <span class="text-slate-400">Cached:</span>
          <span class="font-semibold text-slate-200">${files.length}</span>
          <span class="text-slate-400">files</span>
        </span>

        <span class="inline-flex items-center gap-2 rounded-md bg-slate-800 px-2.5 py-1 text-slate-300">
          <span class="text-slate-400">Chain:</span>
          <span class="font-semibold text-slate-200">${compilationChain.length}</span>
          <span class="text-slate-400">steps</span>
        </span>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="mb-6 flex flex-wrap gap-2 border-b border-slate-800 pb-3">
      <button data-tab="stack"
        class="tab-btn inline-flex items-center gap-2 rounded-md bg-sky-500/20 px-3 py-2 text-sm font-medium text-sky-300 transition hover:bg-slate-800 hover:text-slate-100">
        <span class="iconify" data-icon="mdi:bug-outline"></span>
        Stack Trace
      </button>

      <button data-tab="files"
        class="tab-btn inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-300 transition hover:bg-slate-700 hover:text-slate-100">
        <span class="iconify" data-icon="mdi:file-multiple-outline"></span>
        Cached Files <span class="rounded bg-slate-700 px-2 py-0.5 text-xs text-slate-200">${files.length}</span>
      </button>

      <button data-tab="chain"
        class="tab-btn inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-300 transition hover:bg-slate-700 hover:text-slate-100">
        <span class="iconify" data-icon="mdi:link-variant"></span>
        Compilation Chain
      </button>

      ${hasCodeFrame ? `
        <button data-tab="codeframe"
          class="tab-btn inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-300 transition hover:bg-slate-700 hover:text-slate-100">
          <span class="iconify" data-icon="mdi:code-braces"></span>
          Code Frame
        </button>
      ` : ""}

      ${hasGeneratedCode ? `
        <button data-tab="generated"
          class="tab-btn inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-300 transition hover:bg-slate-700 hover:text-slate-100">
          <span class="iconify" data-icon="mdi:code-json"></span>
          Generated Code
        </button>
      ` : ""}
    </nav>

    <!-- Layout -->
    <div class="grid gap-6 lg:grid-cols-3">
      <!-- Main panel -->
      <main class="lg:col-span-2 space-y-6">
        <!-- Stack -->
        <section data-tab-panel="stack" class="tab-panel space-y-3">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Stack Trace</h2>

            <button type="button" data-copy-from="stack-pre"
              class="inline-flex items-center gap-2 rounded-md bg-sky-500/20 px-3 py-2 text-sm font-medium text-sky-300 transition hover:bg-sky-500/30">
              <span class="iconify" data-icon="mdi:content-copy"></span>
              Copy
            </button>
          </div>

          <pre id="stack-pre"
            class="max-h-[70vh] overflow-auto rounded-lg border border-slate-800 bg-slate-950 p-4 font-mono text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words">${stack}</pre>
        </section>

        <!-- Code Frame -->
        ${hasCodeFrame ? `
        <section data-tab-panel="codeframe" class="tab-panel hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Code Frame</h2>

            <button type="button" data-copy-from="codeframe-pre"
              class="inline-flex items-center gap-2 rounded-md bg-sky-500/20 px-3 py-2 text-sm font-medium text-sky-300 transition hover:bg-sky-500/30">
              <span class="iconify" data-icon="mdi:content-copy"></span>
              Copy
            </button>
          </div>

          <pre id="codeframe-pre"
            class="max-h-[70vh] overflow-auto rounded-lg border border-red-500/30 bg-red-500/10 p-4 font-mono text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words text-red-200">${codeFrame}</pre>
        </section>
        ` : ""}

        <!-- Generated -->
        ${hasGeneratedCode ? `
        <section data-tab-panel="generated" class="tab-panel hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Generated Code</h2>

            <button type="button" data-copy-from="generated-pre"
              class="inline-flex items-center gap-2 rounded-md bg-sky-500/20 px-3 py-2 text-sm font-medium text-sky-300 transition hover:bg-sky-500/30">
              <span class="iconify" data-icon="mdi:content-copy"></span>
              Copy
            </button>
          </div>

          <pre id="generated-pre"
            class="max-h-[70vh] overflow-auto rounded-lg border border-slate-800 bg-slate-950 p-4 font-mono text-xs leading-relaxed whitespace-pre text-emerald-200">${generatedCode}</pre>
        </section>
        ` : ""}

        <!-- Chain -->
        <section data-tab-panel="chain" class="tab-panel hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Compilation Chain</h2>

            <button type="button" data-copy-chain="1"
              class="inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 transition hover:bg-slate-700">
              <span class="iconify" data-icon="mdi:content-copy"></span>
              Copy list
            </button>
          </div>

          <div class="rounded-lg border border-slate-800 bg-slate-950 p-3">
            ${
              compilationChain.length > 0
                ? compilationChain
                    .map((file: string, i: number) => {
                      const safeFile = escapeHtml(String(file));
                      const isFirst = i === 0;
                      const isLast = i === compilationChain.length - 1;

                      const accent = isFirst
                        ? "border-red-400/60 bg-red-500/5"
                        : isLast
                          ? "border-rose-300/60 bg-rose-500/5"
                          : "border-sky-400/50 bg-sky-500/5";

                      const badge = isFirst
                        ? `<span class="ml-2 rounded bg-red-500/15 px-2 py-0.5 text-xs text-red-200">Entry</span>`
                        : isLast
                          ? `<span class="ml-2 rounded bg-rose-500/15 px-2 py-0.5 text-xs text-rose-200">Error</span>`
                          : "";

                      return `
                        <div class="mb-2 last:mb-0 rounded-md border-l-4 ${accent} px-3 py-2">
                          <div class="flex items-start gap-3">
                            <span class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-800 text-xs text-slate-200">${i + 1}</span>
                            <div class="min-w-0">
                              <div class="font-mono text-sm text-slate-100 break-words">${safeFile}${badge}</div>
                            </div>
                          </div>
                        </div>
                      `;
                    })
                    .join("")
                : `<div class="px-3 py-10 text-center text-slate-400">No compilation chain available.</div>`
            }
          </div>
        </section>

        <!-- Files -->
        <section data-tab-panel="files" class="tab-panel hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xs font-semibold tracking-wider uppercase text-slate-400">
              Cached Files (${files.length})
            </h2>

            <button type="button" data-copy-files="1"
              class="inline-flex items-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 transition hover:bg-slate-700">
              <span class="iconify" data-icon="mdi:content-copy"></span>
              Copy list
            </button>
          </div>

          <div class="rounded-lg border border-slate-800 bg-slate-950">
            <div class="max-h-[70vh] overflow-auto p-2">
              ${
                files.length
                  ? files
                      .map(
                        (f) => `
                          <div class="rounded-md px-3 py-2 font-mono text-xs sm:text-sm text-slate-200 hover:bg-slate-800 break-words">
                            ${escapeHtml(String(f))}
                          </div>
                        `
                      )
                      .join("")
                  : `<div class="px-3 py-10 text-center text-slate-500">No files in cache.</div>`
              }
            </div>
            <div class="border-t border-slate-800 px-4 py-3 text-sm text-slate-400">
              ${files.length} files cached for hot reload.
            </div>
          </div>
        </section>
      </main>

      <!-- Side panel -->
      <aside class="space-y-6">
        <section class="rounded-lg border border-slate-800 bg-slate-950 p-4">
          <h3 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Quick Actions</h3>

          <div class="mt-3 grid gap-2">
            <button type="button" data-action="reload"
              class="inline-flex items-center justify-center gap-2 rounded-md bg-sky-500/20 px-3 py-2 text-sm font-medium text-sky-300 transition hover:bg-sky-500/30">
              <span class="iconify" data-icon="mdi:reload"></span>
              Reload Page
            </button>

            <button type="button" data-action="copy-text-report"
              class="inline-flex items-center justify-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 transition hover:bg-slate-700">
              <span class="iconify" data-icon="mdi:file-document-outline"></span>
              Copy Text Report
            </button>

            <button type="button" data-action="copy-html"
              class="inline-flex items-center justify-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 transition hover:bg-slate-700">
              <span class="iconify" data-icon="mdi:code-tags"></span>
              Copy HTML
            </button>

            <button type="button" data-action="back"
              class="inline-flex items-center justify-center gap-2 rounded-md bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 transition hover:bg-slate-700">
              <span class="iconify" data-icon="mdi:arrow-left"></span>
              Back
            </button>
          </div>
        </section>

        <section class="rounded-lg border border-slate-800 bg-slate-950 p-4">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-xs font-semibold tracking-wider uppercase text-slate-400">Kire Dev Server</h3>
            <span class="rounded-full bg-red-500/20 px-2 py-0.5 text-xs text-red-300">v1.0</span>
          </div>

          <div class="mt-3 text-sm text-slate-400">
            <p class="mb-2">This error page is generated by the Kire development server.</p>
            <p>Use tabs to navigate between error details and system information.</p>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"
    class="pointer-events-none fixed bottom-4 right-4 hidden max-w-sm rounded-lg border border-slate-800 bg-slate-950/95 px-4 py-3 text-sm text-slate-100 shadow-lg">
    <div class="flex items-center gap-2">
      <span class="iconify text-green-400" data-icon="mdi:check-circle-outline"></span>
      <span id="toast-msg">Copied to clipboard!</span>
    </div>
  </div>

  <script>
    (function () {
      const btns = Array.from(document.querySelectorAll(".tab-btn"));
      const panels = Array.from(document.querySelectorAll(".tab-panel"));

      function setActiveTab(name) {
        // Panels
        panels.forEach(p => {
          const isTarget = p.getAttribute("data-tab-panel") === name;
          p.classList.toggle("hidden", !isTarget);
        });

        // Buttons
        btns.forEach(b => {
          const isTarget = b.getAttribute("data-tab") === name;
          b.classList.toggle("bg-sky-500/20", isTarget);
          b.classList.toggle("text-sky-300", isTarget);
          b.classList.toggle("hover:bg-slate-800", isTarget);

          b.classList.toggle("bg-slate-800", !isTarget);
          b.classList.toggle("text-slate-300", !isTarget);
          b.classList.toggle("hover:bg-slate-700", !isTarget);
        });
      }

      btns.forEach(b => {
        b.addEventListener("click", () => setActiveTab(b.getAttribute("data-tab")));
      });

      // default tab
      setActiveTab("stack");

      // Toast
      let toastTimer = null;
      function toast(msg) {
        const el = document.getElementById("toast");
        const msgEl = document.getElementById("toast-msg");
        if (!el || !msgEl) return;

        msgEl.textContent = msg || "Copied to clipboard!";
        el.classList.remove("hidden");

        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => el.classList.add("hidden"), 1800);
      }

      // Generate comprehensive text report
      function generateTextReport() {
        const now = new Date();
        const report = [
          "=".repeat(60),
          "KIRE ERROR REPORT",
          "=".repeat(60),
          "Timestamp: " + now.toISOString(),
          "Error: " + ${JSON.stringify(errorTitle)},
          "URL: " + ${JSON.stringify(method)} + " " + ${JSON.stringify(url)},
          "",
          "STACK TRACE:",
          ${JSON.stringify(stack)},
          "",
          "COMPILATION CHAIN (" + ${JSON.stringify(compilationChain.length)} + " steps):"
        ];

        ${JSON.stringify(compilationChain)}.forEach((file, i) => {
          const prefix = i === 0 ? "[Entry] " : i === ${JSON.stringify(compilationChain)}.length - 1 ? "[Error] " : "";
          report.push((i + 1) + ". " + prefix + file);
        });

        report.push(
          "",
          "CACHED FILES (" + ${JSON.stringify(files.length)} + "):"
        );

        ${JSON.stringify(files)}.forEach(f => {
          report.push("â€¢ " + f);
        });

        report.push(
          "",
          "CODE FRAME:",
          ${JSON.stringify(codeFrame || "No code frame available")},
          "",
          "GENERATED CODE:",
          ${JSON.stringify(generatedCode || "No generated code available")},
          "=".repeat(60),
          "End of Report",
          "=".repeat(60)
        );

        return report.join("\\n");
      }

      // Clipboard helpers
      async function copyText(text) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            toast("Copied to clipboard!");
            return true;
          }
        } catch (_) {}

        // fallback
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "true");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          toast("Copied to clipboard!");
          return true;
        } catch (err) {
          console.error("Error copying:", err);
          toast("Failed to copy");
          return false;
        }
      }

      // Copy buttons (from element)
      document.querySelectorAll("[data-copy-from]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-copy-from");
          const el = document.getElementById(id);
          const text = el ? el.innerText : "";
          copyText(text);
        });
      });

      // Copy chain/files as list
      const chain = ${JSON.stringify(compilationChain)};
      const files = ${JSON.stringify(files)};

      const chainBtn = document.querySelector("[data-copy-chain]");
      if (chainBtn) {
        chainBtn.addEventListener("click", () => copyText(chain.join("\\n")));
      }

      const filesBtn = document.querySelector("[data-copy-files]");
      if (filesBtn) {
        filesBtn.addEventListener("click", () => copyText(files.join("\\n")));
      }

      // Quick actions
      document.querySelectorAll("[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          if (action === "reload") window.location.reload();
          if (action === "copy-text-report") copyText(generateTextReport());
          if (action === "copy-html") copyText(document.documentElement.outerHTML);
          if (action === "back") history.back();
        });
      });

      // Auto-reload (dev)
      if (typeof EventSource !== "undefined") {
        try {
          const evtSource = new EventSource("/kire-livereload");
          evtSource.onmessage = (e) => {
            if (e.data === "reload") {
              console.log("[Kire] Reloading due to file changes...");
              window.location.reload();
            }
          };
        } catch (e) {
          // ignore
        }
      }
    })();
  </script>
</body>
</html>
  `;
}

