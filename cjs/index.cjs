"use strict";var X=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames,be=Object.getOwnPropertySymbols;var Ae=Object.prototype.hasOwnProperty,Ne=Object.prototype.propertyIsEnumerable;var ge=(n,e,s)=>e in n?X(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s,te=(n,e)=>{for(var s in e||(e={}))Ae.call(e,s)&&ge(n,s,e[s]);if(be)for(var s of be(e))Ne.call(e,s)&&ge(n,s,e[s]);return n};var De=(n,e)=>{for(var s in e)X(n,s,{get:e[s],enumerable:!0})},we=(n,e,s,u)=>{if(e&&typeof e=="object"||typeof e=="function")for(let l of Re(e))!Ae.call(n,l)&&l!==s&&X(n,l,{get:()=>e[l],enumerable:!(u=Pe(e,l))||u.enumerable});return n};var Be=n=>we(X({},"__esModule",{value:!0}),n);var F=(n,e,s)=>new Promise((u,l)=>{var y=d=>{try{o(s.next(d))}catch(f){l(f)}},g=d=>{try{o(s.throw(d))}catch(f){l(f)}},o=d=>d.done?u(d.value):Promise.resolve(d.value).then(y,g);o((s=s.apply(n,e)).next())});var Fe={};De(Fe,{AsyncFunction:()=>de,DIRECTIVE_REGEX:()=>ie,EJBBunResolver:()=>Te,EJBNodeJSResolver:()=>Ce,EJB_DEFAULT_PREFIX_DIRECTIVE:()=>G,EJB_DEFAULT_PREFIX_GLOBAL:()=>he,EJB_DEFAULT_PREFIX_VARIABLE:()=>M,ESCAPE_HTML:()=>re,ESPACE_HTML_REGEX:()=>se,Ejb:()=>me,EjbAst:()=>z,HTML_REGULAR_REGEX:()=>oe,PromiseResolver:()=>T,compile:()=>K,ejbDirective:()=>R,ejbParser:()=>k,escapeHtml:()=>Z,escapeJs:()=>C,escapeRegExp:()=>ce,escapeString:()=>ae,filepathResolver:()=>O,generateNodeCode:()=>W,generateNodeString:()=>Q,isPromise:()=>h,join:()=>ue,md5:()=>le,returnEjbRes:()=>fe,trimQuotes:()=>q});module.exports=Be(Fe);var he="it",G="@",M="{{*}}",re={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},se=/[&<>"'']/g,oe=/<[a-z][\s\S]*>/i,ie=/^\s*([a-zA-Z0-9]+)(?:\s*\(([\s\S]*?)\))?/,z=(y=>(y[y.Root=0]="Root",y[y.Text=1]="Text",y[y.Interpolation=2]="Interpolation",y[y.Directive=3]="Directive",y[y.SubDirective=4]="SubDirective",y))(z||{});function R(n){return{[n.name.toString()]:n}}function ce(n){return n.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}function ae(n){return typeof n!="string"?n:n.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f").replace(/\b/g,"\\b").replace(/\v/g,"\\v")}var C=n=>n.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$\{/g,"\\${");function Z(n){return n==null?"":String(n).replace(se,e=>re[e])}function le(n){function e(t,p){return t<<p|t>>>32-p}function s(t,p){let A=t&2147483648,v=p&2147483648,x=t&1073741824,j=p&1073741824,E=(t&1073741823)+(p&1073741823);return x&j?E^2147483648^A^v:x|j?E&1073741824?E^3221225472^A^v:E^1073741824^A^v:E^A^v}function u(t,p,A){return t&p|~t&A}function l(t,p,A){return t&A|p&~A}function y(t,p,A){return t^p^A}function g(t,p,A){return p^(t|~A)}function o(t,p,A,v,x,j,E){return t=s(t,s(s(u(p,A,v),x),E)),s(e(t,j),p)}function d(t,p,A,v,x,j,E){return t=s(t,s(s(l(p,A,v),x),E)),s(e(t,j),p)}function f(t,p,A,v,x,j,E){return t=s(t,s(s(y(p,A,v),x),E)),s(e(t,j),p)}function b(t,p,A,v,x,j,E){return t=s(t,s(s(g(p,A,v),x),E)),s(e(t,j),p)}function I(t){let p,A=t.length,v=A+8,j=((v-v%64)/64+1)*16,E=new Array(j-1),_=0,P=0;for(;P<A;)p=(P-P%4)/4,_=P%4*8,E[p]=E[p]|t.charCodeAt(P)<<_,P++;return p=(P-P%4)/4,_=P%4*8,E[p]=E[p]|128<<_,E[j-2]=A<<3,E[j-1]=A>>>29,E}function w(t){let p="",A="",v,x;for(x=0;x<=3;x++)v=t>>>x*8&255,A="0"+v.toString(16),p=p+A.substr(A.length-2,2);return p}let m=I(n),i=1732584193,c=4023233417,a=2562383102,r=271733878;for(let t=0;t<m.length;t+=16){let p=i,A=c,v=a,x=r;i=o(i,c,a,r,m[t+0],7,3614090360),r=o(r,i,c,a,m[t+1],12,3905402710),a=o(a,r,i,c,m[t+2],17,606105819),c=o(c,a,r,i,m[t+3],22,3250441966),i=o(i,c,a,r,m[t+4],7,4118548399),r=o(r,i,c,a,m[t+5],12,1200080426),a=o(a,r,i,c,m[t+6],17,2821735955),c=o(c,a,r,i,m[t+7],22,4249261313),i=o(i,c,a,r,m[t+8],7,1770035416),r=o(r,i,c,a,m[t+9],12,2336552879),a=o(a,r,i,c,m[t+10],17,4294925233),c=o(c,a,r,i,m[t+11],22,2304563134),i=o(i,c,a,r,m[t+12],7,1804603682),r=o(r,i,c,a,m[t+13],12,4254626195),a=o(a,r,i,c,m[t+14],17,2792965006),c=o(c,a,r,i,m[t+15],22,1236535329),i=d(i,c,a,r,m[t+1],5,4129170786),r=d(r,i,c,a,m[t+6],9,3225465664),a=d(a,r,i,c,m[t+11],14,643717713),c=d(c,a,r,i,m[t+0],20,3921069994),i=d(i,c,a,r,m[t+5],5,3593408605),r=d(r,i,c,a,m[t+10],9,38016083),a=d(a,r,i,c,m[t+15],14,3634488961),c=d(c,a,r,i,m[t+4],20,3889429448),i=d(i,c,a,r,m[t+9],5,568446438),r=d(r,i,c,a,m[t+14],9,3275163606),a=d(a,r,i,c,m[t+3],14,4107603335),c=d(c,a,r,i,m[t+8],20,1163531501),i=d(i,c,a,r,m[t+13],5,2850285829),r=d(r,i,c,a,m[t+2],9,4243563512),a=d(a,r,i,c,m[t+7],14,1735328473),c=d(c,a,r,i,m[t+12],20,2368359562),i=f(i,c,a,r,m[t+5],4,4294588738),r=f(r,i,c,a,m[t+8],11,2272392833),a=f(a,r,i,c,m[t+11],16,1839030562),c=f(c,a,r,i,m[t+14],23,4259657740),i=f(i,c,a,r,m[t+1],4,2763975236),r=f(r,i,c,a,m[t+4],11,1272893353),a=f(a,r,i,c,m[t+7],16,4139469664),c=f(c,a,r,i,m[t+10],23,3200236656),i=f(i,c,a,r,m[t+13],4,681279174),r=f(r,i,c,a,m[t+0],11,3936430074),a=f(a,r,i,c,m[t+3],16,3572445317),c=f(c,a,r,i,m[t+6],23,76029189),i=f(i,c,a,r,m[t+9],4,3654602809),r=f(r,i,c,a,m[t+12],11,3873151461),a=f(a,r,i,c,m[t+15],16,530742520),c=f(c,a,r,i,m[t+2],23,3299628645),i=b(i,c,a,r,m[t+0],6,4096336452),r=b(r,i,c,a,m[t+7],10,1126891415),a=b(a,r,i,c,m[t+14],15,2878612391),c=b(c,a,r,i,m[t+5],21,4237533241),i=b(i,c,a,r,m[t+12],6,1700485571),r=b(r,i,c,a,m[t+3],10,2399980690),a=b(a,r,i,c,m[t+10],15,4293915773),c=b(c,a,r,i,m[t+1],21,2240044497),i=b(i,c,a,r,m[t+8],6,1873313359),r=b(r,i,c,a,m[t+15],10,4264355552),a=b(a,r,i,c,m[t+6],15,2734768916),c=b(c,a,r,i,m[t+13],21,1309151649),i=b(i,c,a,r,m[t+4],6,4149444226),r=b(r,i,c,a,m[t+11],10,3174756917),a=b(a,r,i,c,m[t+2],15,718787259),c=b(c,a,r,i,m[t+9],21,3951481745),i=s(i,p),c=s(c,A),a=s(a,v),r=s(r,x)}return w(i)+w(c)+w(a)+w(r)}function ue(...n){var d;if(!n.length)return".";let e=/^[a-zA-Z]:[\\/]/,s=n.some(f=>e.test(f)),u=s?(d=n.find(f=>e.test(f)))==null?void 0:d.charAt(0).toUpperCase():null,l=n.map(f=>f.replace(/\\/g,"/").replace(/\/+/g,"/")).join("/").replace(/\/+/g,"/");s&&u&&(l=l.replace(/^[a-zA-Z]:/,u));let y=/^(?:\/|[a-zA-Z]:\/)/.test(l),o=l.split("/").filter(f=>f&&f!==".").reduce((f,b)=>b===".."?f.length&&f[f.length-1]!==".."?f.slice(0,-1):[...f,b]:[...f,b],[]).join("/");return s?(o=o.replace(/^([a-zA-Z]:)/,(f,b)=>`${b.toUpperCase()}/`).replace(/^\//,`${u}:/`).replace(/\//g,"\\"),o=o.replace(/\\+/g,"\\"),o||"."):(y&&(o=`/${o.replace(/^\//,"")}`),o===""?".":o)}var O=(n,e,s)=>{if(!e)return e;e=e.replace(/\\/g,"/").replace(/\/+/g,"/");let u=(n.root||".").replace(/\\/g,"/").replace(/\/$/,""),l=/^(?:\/|[a-zA-Z]:\/)/.test(e),y=Object.entries(n.aliases).sort(([g],[o])=>o.length-g.length).find(([g])=>new RegExp(`^${g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`).test(e));if(y){let[g,o]=y;e=ue(o,e.slice(g.length))}else if(!l){let g=s?s.replace(/\/[^/]*$/,""):u;e=ue(g,e)}if(n.extension&&!/\.[^/.]+$/.test(e)){let g=n.extension.startsWith(".")?n.extension:`.${n.extension}`;e=e+g}return e.replace(/\/+/g,"/")};function h(n){return n!==null&&typeof n=="object"&&typeof n.then=="function"}function T(n,...e){let s=(u,l=0)=>{if(l>=e.length)return u;let y=e[l](u);return h(y)?y.then(g=>s(g,l+1)):s(y,l+1)};return h(n)?n.then(u=>s(u)):s(n)}var de=Object.getPrototypeOf(()=>F(null,null,function*(){})).constructor;function q(n){return typeof n!="string"?n:n.replace(/^['"`]+|['"`]+$/g,"").trim()}function fe(n,e){return`(${n.async?"await":""}(${n.async?"async":""}($ejb) => {${e}; return $ejb.res})({...$ejb, res:''}))`}function Je(n,e,s,u=[]){return s?Q(n,e,u):W(n,e,u)}function pe(n,e,s=!1,u=[]){if(!e.length)return n.async?Promise.resolve(""):"";let l=e.map(g=>Je(n,g,s,u));if(l.some(h)){if(!n.async)throw new Error("[EJB] Async operation in sync mode");return Promise.all(l).then(g=>g.join(""))}return l.join("")}function Q(n,e,s=[]){switch(e.type){case 0:return pe(n,e.children,!0,s);case 1:return C(e.value);case 2:{let{expression:u}=e;return u}default:return n.async?Promise.resolve(""):""}}function W(n,e,s=[]){switch(e.type){case 0:return pe(n,e.children,!1,s);case 1:return`$ejb.res += \`${C(e.value)}\`;
`;case 2:{let{expression:u,escaped:l}=e;return`$ejb.res += ${l?`$ejb.escapeHtml(${u})`:u};
`}case 3:case 4:return Se(n,e,!1,s);default:return n.async?Promise.resolve(""):""}}function Se(n,e,s,u){var a;let{name:l,expression:y,children:g=[]}=e,o;if(e.type===4){let r=e.parent_name,t=n.directives[r];if(o=(a=t==null?void 0:t.parents)==null?void 0:a.find(p=>p.name===l),!o){let p=`[EJB] Sub-directive "${l}" not found in parent "${r}"`;return n.async?Promise.reject(new Error(p)):p}}else if(o=n.directives[l],!o){let r=`[EJB] Directive not found: ${l}`;return n.async?Promise.reject(new Error(r)):r}let f=(r,...t)=>{try{let p=r(...t);if(h(p)&&!n.async)throw new Error(`[EJB] Async operation in sync mode for @${l}`);return p}catch(p){return n.async?Promise.reject(p):p}};if(typeof o.name!="string"){if(o.onNameResolver){let r=o.name.exec(y);if(r){let t=f(o.onNameResolver,n,r);return h(t)?t.then(p=>`$ejb.res += ${JSON.stringify(p||"")};`):`$ejb.res += ${JSON.stringify(t||"")};`}}return n.async?Promise.resolve(""):""}let b="",I=[...u,g.filter(r=>r.type===4).filter(Boolean)];if(o.onInit){let r=f(o.onInit,n,y);if(h(r))return n.async?r.then(t=>(b+=t||"",w())):`[EJB] Async init in sync mode for @${l}`;b+=r||""}let w=()=>{if(o.onParams){let r=f(o.onParams,n,y);if(h(r))return n.async?r.then(t=>(b+=t||"",m())):`[EJB] Async params in sync mode for @${l}`;b+=r||""}return m()},m=()=>{let r=g.filter(p=>p.type!==4),t=g.filter(p=>p.type===4);if(r.length>0)if(o.onChildren){let p=f(o.onChildren,n,{children:r,parents:I});if(h(p))return n.async?p.then(A=>(b+=A||"",i(t))):`[EJB] Async children handler in sync mode for @${l}`;b+=p||""}else{let p=pe(n,r,s,I);if(h(p))return n.async?p.then(A=>(b+=A||"",i(t))):`[EJB] Async children in sync mode for @${l}`;b+=p||""}return i(t)},i=r=>{if(r.length>0){let t=r.map(A=>W(n,A,I));if(t.some(h))return n.async?Promise.all(t).then(A=>(b+=A.join(""),c())):`[EJB] Async sub-directives in sync mode for @${l}`;b+=t.join("")}return c()},c=()=>{if(o.onEnd){let r=f(o.onEnd,n);if(h(r))return n.async?r.then(t=>(b+=t||"",b)):`[EJB] Async end in sync mode for @${l}`;b+=r||""}return b};return w()}function K(n,e){let s=Object.values(n.directives).filter(o=>o.onInitFile||o.onEndFile),u=s.filter(o=>o.onInitFile).map(o=>{var d;return(d=o.onInitFile)==null?void 0:d.call(o,n)}).filter(Boolean),l=W(n,e,[]),y=s.filter(o=>o.onEndFile).map(o=>{var d;return(d=o.onEndFile)==null?void 0:d.call(o,n)}).filter(Boolean),g=(o,d,f)=>{let b="";if(n.globalexpose){let I=Object.keys(n.globals);I.length>0&&(b=`const { ${I.join(", ")} } = ${n.globalvar};
`)}return`${o}
${b}${d}${f?`
${f}`:""}
return $ejb;`};if(!h(l)&&!u.some(h)&&!y.some(h))return g(u.join(`
`),l,y.join(`
`));if(!n.async)throw new Error("[EJB] Async compilation in sync mode");return F(null,null,function*(){let[o,d,f]=yield Promise.all([l,Promise.all(u.filter(h)),Promise.all(y.filter(h))]),b=u.map(w=>h(w)?d.shift():w).join(`
`),I=y.map(w=>h(w)?f.shift():w).join(`
`);return g(b,o,I)})}function H(n,e,s){return{line:n,column:e,offset:s}}function k(n,e){var m,i,c,a;let s=1,u=1,l=0,y=r=>{let t=r.split(`
`);t.length>1?(s+=t.length-1,u=t[t.length-1].length+1):u+=r.length,l+=r.length},g=r=>({start:r,end:H(s,u,l)}),o={type:0,children:[],loc:{start:H(1,1,0),end:H(s,u,e.length)}},d=[o],[f,b]=M.split("*"),I="@",w=Object.values(n.directives).filter(r=>typeof r.name!="string");for(;l<e.length;){let r=d[d.length-1];if(!r)break;let t=H(s,u,l),p=e.substring(l),A=p.indexOf(I),v=p.indexOf(f),x=null;if(w.length>0)for(let _ of w){let P=_.name,$=p.match(P);$&&$.index!==void 0&&(x===null||$.index<x.index)&&(x={index:$.index,length:$[0].length,directive:_,match:$})}let j=Math.min(A!==-1?A:1/0,v!==-1?v:1/0,x?x.index:1/0);if(j!==1/0&&j>0){let _=p.substring(0,j);r.children.push({type:1,value:_,loc:g(t)}),y(_);continue}if(j===1/0){p.length>0&&(r.children.push({type:1,value:p,loc:g(t)}),y(p));break}let E=H(s,u,l);if(j===(x==null?void 0:x.index)){let{directive:_,match:P}=x,$=P[0],V={type:3,name:_.name.toString(),expression:$,children:[],auto_closed:!1,loc:g(E)};r.children.push(V),y($),_.children&&d.push(V);continue}if(j===v){y(f);let _=e.indexOf(b,l);if(_===-1)throw new Error("Unclosed interpolation expression");let P=e.substring(l,_).trim();r.children.push({type:2,expression:P,escaped:!0,loc:g(E)}),y(e.substring(l,_+b.length));continue}if(j===A){y(I);let _=e.substring(l).match(ie);if(!_)throw new Error("Invalid directive");let[P,$,V=""]=_,ye=V.trim(),J=null,L=!1;for(let B=d.length-1;B>=0;B--){let S=d[B];if(S.type===3||S.type===4){let D=n.directives[S.name];if((m=D==null?void 0:D.parents)!=null&&m.some(U=>U.name===$)){J=S,L=!0;break}}}if(!L&&($==="end"||d.some(B=>B.type!==0&&B.name===$))){if(d.length===1)throw new Error(`Unexpected ${I}${$} directive`);if(y(P),$==="end"){d.pop();continue}let B=d.findLastIndex((S,D)=>D>0&&S.type!==0&&S.name===$);if(B===-1)throw new Error(`No matching ${I}${$} directive to close`);d.length=B;continue}if(!L)for(let B=d.length-1;B>=0;B--){let S=d[B];if(S.type===3||S.type===4){let D=n.directives[S.name];if((i=D==null?void 0:D.parents)!=null&&i.some(U=>U.name===$)){J=S,L=!0;break}}}let Y=L?(a=(c=n.directives[J==null?void 0:J.name])==null?void 0:c.parents)==null?void 0:a.find(B=>B.name===$):n.directives[$];if(!Y)throw new Error(`[EJB] Directive not found: ${I}${$}`);let ee=g(E);ee.end=H(s,u+P.length,l+P.length);let ne=L?{type:4,name:$,expression:ye,children:[],auto_closed:!1,parent_name:J==null?void 0:J.name,loc:ee}:{type:3,name:$,expression:ye,children:[],auto_closed:!1,loc:ee};if(y(P),L&&J){let S=J.children.filter(D=>D.type===4&&D.name===$&&D.parent_name===(J==null?void 0:J.name)&&!D.auto_closed);for(let D of S){D.auto_closed=!0;let U=d.indexOf(D);U!==-1&&U===d.length-1&&d.pop()}J.children.push(ne)}else r.children.push(ne);(L||"children"in Y||"internal"in Y)&&d.push(ne)}}for(;d.length>1;){let r=d.pop();r.auto_closed=!0}return o.loc.end=H(s,u,l),o}var xe=R({name:"component",priority:10,children:!0,description:"Renders a template as a component, allowing for slots.",example:`@component('./components/card.ejb')
    @slot('title')
        My Card Title
    @end
    <p>This is the default slot content.</p>
@end`,parents:[{name:"slot",internal:!0,onParams:(n,e)=>`$slots["$" + ${e}] = ${n.async?"await":""} (${n.async?"async":""} ($ejb) => {`,onEnd:()=>`
return $ejb.res;})({ ...$ejb, res:'' });`}],onInit:n=>`$ejb.res += ${n.async?"await":""} (${n.async?"async":""} ($ejb) => { const $slots = {};
`,onEnd:()=>"return $_component($_import, {...$_variables, ...$slots}); })({ ...$ejb, res:'' });",onChildren:(n,{children:e,parents:s})=>T(n.compileNode(e),u=>T(n.compileNode(s!=null?s:[]),l=>`$slots.$slot = ${fe(n,u)} ?? "";
 ${l!=null?l:""}
`)),onParams:(n,e)=>{let s=e.indexOf(","),u=(s===-1?e:e.slice(0,s)).trim().replace(/['"`]/g,""),l=(s===-1?"{}":e.slice(s+1)).trim();if(!n.resolver)throw new Error("[EJB] @ directive requires a resolver to be configured.");try{let y=n.resolver(O(n,u));if(!n.async&&h(y))throw new Error(`[EJB] Resolver for path "${u}" returned a Promise in sync mode. A sync resolver must be provided.`);return T(y,g=>{let o=k(n,g),d=n.compileNode(o);if(!n.async&&h(d))throw new Error(`[EJB] Sync import compilation for "${u}" unexpectedly resulted in a Promise.`);return T(d,f=>["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${n.globalvar}, ...(${l}) };`,`const $_component = new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${C(f)}\\nreturn $ejb.res;\`);
`].join(`
`))})}catch(y){return console.error(`[EJB] Failed to resolve import for path: ${u}`,y),`return \`<!-- EJB Import Error: ${C(y.message)} -->\`;`}}});var Ee=R({name:"import",priority:10,children:!1,description:"Imports and renders another EJB template file.",example:"@import('./path/to/template.ejb', { myVar: 'value' })",onInit:n=>`$ejb.res += ${n.async?"await":""} (${n.async?"async":""} ($ejb) => {`,onEnd:()=>"})({ ...$ejb, res:'' });",onParams:(n,e)=>{let s=e.indexOf(","),u=(s===-1?e:e.slice(0,s)).trim().replace(/['"`]/g,""),l=(s===-1?"{}":e.slice(s+1)).trim();if(!n.resolver)throw new Error("[EJB] @import directive requires a resolver to be configured.");try{let y=n.resolver(O(n,u));if(!n.async&&h(y))throw new Error(`[EJB] Resolver for path "${u}" returned a Promise in sync mode. A sync resolver must be provided.`);return T(y,g=>{let o=k(n,g),d=n.compileNode(o);if(!n.async&&h(d))throw new Error(`[EJB] Sync import compilation for "${u}" unexpectedly resulted in a Promise.`);return T(d,f=>["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${n.globalvar}, ...(${l}) };`,`return new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${C(f)}\\nreturn $ejb.res;\`)($_import, $_variables)`].join(`
`))})}catch(y){return console.error(`[EJB] Failed to resolve import for path: ${u}`,y),`return \`<!-- EJB Import Error: ${C(y.message)} -->\`;`}}});var ve=Object.assign({},R({name:"stack",priority:1,description:"Retrieves and renders a named stack of content.",example:`<style>
    @stack('styles')
</style>`,onInitFile:()=>`$ejb._stacks = {};

        $ejb.stacks = new Proxy({}, {
            get(target, prop) {
                if(!$ejb._stacks[prop]) $ejb._stacks[prop] = [];
                if (!(prop in target)) {
                    target[prop] = {
                        add(item) {
                            $ejb._stacks[prop].push(item);
                            return this;
                        },
                        join(separator = ",") {
                            return $ejb._stacks[prop].join(separator);
                        }
                    };
                }
                return target[prop];
            }
        });
`,onParams(n,e){return`$ejb.res = $ejb._stacks[${e}] ? ($ejb.res + $ejb.stacks[${e}].join('\\n')) : ($ejb.res + '<!-- EJB:stack(${q(e)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.stacks).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:stack(\${pushname}) -->\`).join($ejb.stacks[pushname].join('\\n'));
                });
    
                // remove not used stacks
                $ejb.res = $ejb.res.replace(/<!-- EJB:stack\\(.*?\\) -->/g, '');`}),R({name:"push",priority:1,children:!0,children_type:"css",description:"Pushes content into a named stack.",example:`@push('styles')
    .my-class { color: red; }
@end`,onInit:(n,e)=>`$ejb.stacks[${e}].add(${n.async?"await":""} (${n.async?"async":""} ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' }));"}),R({name:"defined",priority:11,description:"Retrieves and renders a named defined block.",example:"@defined('myBlock')",onInitFile:()=>"$ejb.defines = {};",onParams(n,e){return`$ejb.res = $ejb.defines[${e}] ? ($ejb.res + $ejb.defines[${e}]) : ($ejb.res + '<!-- EJB:defines(${q(e)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.defines).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:defines(\${pushname}) -->\`).join($ejb.defines[pushname]);
                });
    
                // remove not used defines
                $ejb.res = $ejb.res.replace(/<!-- EJB:defines\\(.*?\\) -->/g, '');`}),R({name:"define",priority:11,children:!0,description:"Defines a reusable block of content.",example:`@define('myBlock')
    <p>Hello, World!</p>
@end`,onInit:(n,e)=>`$ejb.defines[${e}] = ${n.async?"await":""} (${n.async?"async":""} ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' });"}));var $e=Object.assign({},R({name:"code",priority:1,children:!0,children_type:"js",description:"Executes raw JavaScript code on the server side.",example:`
@code
    const myVar = "Hello, EJB!";
    $ejb.res += myVar;
@end`,onChildren:(n,{children:e})=>n.compileNode(e,!0)}),R({name:"if",priority:1,children:!0,description:"Conditionally renders a block of code.",example:`@if(user.isLoggedIn)
    <p>Welcome, {user.name}</p>
@end`,onParams:(n,e)=>`if (${e}) {`,onEnd:()=>"}",parents:[{name:"elseif",internal:!0,description:"An alternative condition for an @if block.",onInit:(n,e)=>`} else if (${e}) {`,onEnd:()=>"}"},{name:"else",internal:!0,description:"The default case for an @if block.",onInit:()=>"else {"}]}),R({name:"for",priority:1,children:!0,description:"Repeats a block of code for each item in an array.",example:`@for(const user of users)
    <p>{user.name}</p>
@end`,onInit:(n,e)=>`for (${e}) {`,onEnd:()=>"}"}),R({name:"isset",priority:1,description:"Checks if a variable is defined and not null, then prints it.",example:"@isset(myVar)",onParams(n,e){return`if(typeof ${e} !== "undefined" && ${e}) $ejb.res += ${e};`}}),R({name:"switch",priority:1,children:!0,description:"A control structure that allows checking a variable against multiple values.",example:`@switch(role)
    @case("admin")
        <p>Admin panel</p>
    @default
        <p>User panel</p>
@end`,onParams:(n,e)=>`switch (${e}) {`,parents:[{name:"case",internal:!0,description:"A case within a @switch block.",onInit:(n,e)=>`case ${e}: {`,onEnd:()=>";break;}"},{name:"default",internal:!0,description:"The default case for a @switch block.",onInit:()=>"default: {",onEnd:()=>"}"}],onChildren:(n,{parents:e})=>T(n.compileNode(e)),onEnd:()=>"}"}),R({name:"once",priority:1,children:!0,description:"Ensures a block of code is rendered only once, even if included multiple times.",example:`@once
    <script src="..." />
@end`,onInitFile:()=>"$ejb.onces = {};",onChildren:(n,e)=>T(n.compileNode(e.children),s=>{let u=le(s);return`if(typeof $ejb.onces['${u}'] == "undefined") {
                $ejb.onces['${u}'] = true;
                ${s}
                `}),onEnd:()=>"};"}));var je=Object.assign({},Ee,xe,ve,$e);var me=class{constructor(e={}){this.getFunction=()=>this.async?de:Function;this.directives={};var s,u,l,y,g,o,d,f;this.aliases=(s=e.aliases)!=null?s:{},this.extension=(u=e.extension)!=null?u:"ejb",this.globals=(l=e.globals)!=null?l:{},this.async=(y=e.async)!=null?y:!1,this.root=(g=e.root)!=null?g:"./",this.globalexpose=(o=e.globalexpose)!=null?o:!0,this.resolver=(d=e.resolver)!=null?d:(b=>{let I=`[EJB]: Resolver not defined, but was required for path: ${b}`;if(this.async)return Promise.reject(new Error(I));throw new Error(I)}),this.directives=Object.assign({},je,e.directives),this.globalvar=(f=e==null?void 0:e.globalvar)!=null?f:"it"}makeFunction(e){var l,y;let s=this.isTemplatePath(e),u=g=>{let o=k(this,g),d=K(this,o),f=b=>`
                return function(${this.globalvar}) {
                    const $ejb = {
                        ins: this,
                        res: '',
                        escapeHtml: ${Z.toString()},
                        escapeJs: ${C.toString()},
                        EjbFunction: ${this.async?"async":""} function() { 
                            return ${this.async?"new (async () => {}).constructor":"Function"}.apply(null, arguments);
                        }
                    };
                    
                    ${b}
                }.bind(this);
            `;if(h(d)){if(!this.async)throw new Error("[EJB] Async compilation in sync mode");return d.then(b=>f(b))}return f(d)};if(s)try{let g=O(this,e),o=(y=(l=this.resolver)==null?void 0:l.call(this,g))!=null?y:e;if(h(o)){if(!this.async)throw new Error("[EJB] Async template loading in sync mode");return F(this,null,function*(){let d=yield o;return u(d)})}return u(o)}catch(g){if(g&&typeof g=="object"&&"code"in g&&g.code==="ENOENT")return console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`),u(e);throw g}return u(e)}compileNode(e,s=!1){let u=Array.isArray(e)?e:[e],l=s?Q:W,y=u.map(o=>l(this,o));if(!y.some(h))return y.join("");if(!this.async)throw new Error("[EJB] Async node compilation in sync mode. Enable async or use sync directives.");return Promise.all(y).then(o=>o.join(""))}parserAst(e){return k(this,e)}render(e,s={}){var o,d;if(this.isTemplatePath(e))try{let f=O(this,e),b=(d=(o=this.resolver)==null?void 0:o.call(this,f))!=null?d:e;if(h(b)){if(!this.async)throw new Error("[EJB] Async template loading in sync mode");return F(this,null,function*(){let I=yield b;return this.render(I,s)})}e=b}catch(f){if(f&&typeof f=="object"&&"code"in f&&f.code==="ENOENT")console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`);else throw f}let l=k(this,e),y=K(this,l),g=f=>new(this.getFunction())("$ejb",this.globalvar,f)({ins:this,res:"",escapeHtml:Z,escapeJs:C,escapeString:ae,EjbFunction:this.getFunction()},te(te({},this.globals),s));if(this.async)return F(this,null,function*(){let f=yield Promise.resolve(y);return(yield g(f)).res});if(h(y))throw new Error("[EJB] Compilation resulted in a Promise in sync mode. Use renderAsync or configure sync resolver/directives.");return g(y).res}isTemplatePath(e){let s=e.trim();if(s.includes(`
`))return!1;let[u]=M.split("*");return s.includes(u)||new RegExp(`^s*${ce("@")}`).test(s)||oe.test(s)?!1:s.includes("/")||s.includes("\\")||s.startsWith("@/")||s.startsWith("@\\")}register(...e){let s=e.map(u=>Object.keys(u).length===1?u:R(u));return this.directives=Object.assign(this.directives,...s),this}};var Ie=require("fs"),_e=require("fs/promises");var Ce=n=>e=>{try{let s={encoding:"utf-8"};return n?(0,_e.readFile)(e,s):(0,Ie.readFileSync)(e,s)}catch(s){return console.error(`[EJB-IMPORT] Failed to resolve: ${e}`,s),n?Promise.resolve(""):""}},Te=n=>F(null,null,function*(){try{let e=Bun.file(n);return(yield e.exists())?yield e.text():""}catch(e){return console.error(`[EJB-IMPORT] Failed to resolve: ${n}`,e),""}});0&&(module.exports={AsyncFunction,DIRECTIVE_REGEX,EJBBunResolver,EJBNodeJSResolver,EJB_DEFAULT_PREFIX_DIRECTIVE,EJB_DEFAULT_PREFIX_GLOBAL,EJB_DEFAULT_PREFIX_VARIABLE,ESCAPE_HTML,ESPACE_HTML_REGEX,Ejb,EjbAst,HTML_REGULAR_REGEX,PromiseResolver,compile,ejbDirective,ejbParser,escapeHtml,escapeJs,escapeRegExp,escapeString,filepathResolver,generateNodeCode,generateNodeString,isPromise,join,md5,returnEjbRes,trimQuotes});
