"use strict";var Z=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var Be=Object.getOwnPropertyNames,Ee=Object.getOwnPropertySymbols;var je=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable;var ye=(t,e,r)=>e in t?Z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,M=(t,e)=>{for(var r in e||(e={}))je.call(e,r)&&ye(t,r,e[r]);if(Ee)for(var r of Ee(e))Fe.call(e,r)&&ye(t,r,e[r]);return t};var ke=(t,e)=>{for(var r in e)Z(t,r,{get:e[r],enumerable:!0})},Le=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Be(e))!je.call(t,i)&&i!==r&&Z(t,i,{get:()=>e[i],enumerable:!(n=Te(e,i))||n.enumerable});return t};var Je=t=>Le(Z({},"__esModule",{value:!0}),t);var f=(t,e,r)=>new Promise((n,i)=>{var s=c=>{try{a(r.next(c))}catch(u){i(u)}},o=c=>{try{a(r.throw(c))}catch(u){i(u)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(s,o);a((r=r.apply(t,e)).next())});var qe={};ke(qe,{AsyncFunction:()=>fe,DIRECTIVE_REGEX:()=>Q,EJBBunResolver:()=>Xe,EJBNodeJSResolver:()=>He,EJB_DEFAULT_PREFIX_DIRECTIVE:()=>J,EJB_DEFAULT_PREFIX_GLOBAL:()=>ve,EJB_DEFAULT_PREFIX_VARIABLE:()=>q,EJB_ESCAPED_PREFIX_DIRECTIVE:()=>X,ESCAPE_HTML:()=>ae,ESPACE_HTML_REGEX:()=>ce,Ejb:()=>z,EjbAst:()=>K,EjbBuilder:()=>be,HTML_REGULAR_REGEX:()=>le,compile:()=>re,ejbDirective:()=>h,ejbParser:()=>S,escapeHtml:()=>Y,escapeJs:()=>N,escapeRegExp:()=>ue,escapeString:()=>pe,filepathResolver:()=>F,generateNodeCode:()=>U,generateNodeString:()=>te,join:()=>de,md5:()=>V,returnEjbRes:()=>ge,trimQuotes:()=>ee});module.exports=Je(qe);var H=require("fs/promises"),W=require("path");var ve="it",J="@",X="@@",q="{{*}}",ae={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},ce=/[&<>"'']/g,le=/<[a-z][\s\S]*>/i,Q=/^\s*([a-zA-Z0-9]+)(?:\s*\(([\s\S]*?)\))?/,K=(s=>(s[s.Root=0]="Root",s[s.Text=1]="Text",s[s.Interpolation=2]="Interpolation",s[s.Directive=3]="Directive",s[s.SubDirective=4]="SubDirective",s))(K||{});function h(t){return{[t.name.toString()]:t}}function Oe(t){let e=[],r=0,n=0,i=!1;for(let o=0;o<t.length;o++){let a=t[o];if(i){a===i&&t[o-1]!=="\\"&&(i=!1);continue}switch(a){case"`":case"'":case'"':i=a;break;case"(":case"[":case"{":r++;break;case")":case"]":case"}":r--;break;case",":if(r===0){let c=t.substring(n,o).trim();c&&e.push(c),n=o+1}break}}let s=t.substring(n).trim();return s&&e.push(s),e}function $e(t){try{return new Function(`return ${t}`)()}catch(e){return}}function xe(t,e){let r=Oe(t),n=new Map(e.map(a=>[a.name,a])),i=a=>{let c=e.findIndex(u=>u.name===a);return c>=0?r[c]:void 0},s=a=>{var u;let c=i(a);return c!==void 0?c:(u=n.get(a))==null?void 0:u.default},o=a=>{var c;return{raw:i(a),string:(c=s(a))==null?void 0:c.replace(/^["'`]|["'`]$/g,""),number:()=>{let u=s(a);return u!==void 0?parseFloat(u):void 0},boolean:()=>{let u=s(a);return u!==void 0?u==="true":void 0},object:()=>$e(s(a)||""),array:()=>$e(s(a)||"")}};return{raw:t,getRaw:a=>o(a).raw,getString:a=>o(a).string,getNumber:a=>o(a).number(),getBoolean:a=>o(a).boolean(),getObject:a=>o(a).object(),getArray:a=>o(a).array()}}function ue(t){return t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}function pe(t){return typeof t!="string"?t:t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f").replace(/\b/g,"\\b").replace(/\v/g,"\\v")}var N=t=>t.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$\{/g,"\\${");function Y(t){return t==null?"":String(t).replace(ce,e=>ae[e])}function V(t){let e=[[7,12,17,22],[5,9,14,20],[4,11,16,23],[6,10,15,21]],r=[],n=0;for(;n<64;)r[n]=Math.floor(Math.abs(Math.sin(n+1))*4294967296)>>>0,n++;let i=(g,p)=>g<<p|g>>>32-p,s=(g,p)=>{let m=(g&65535)+(p&65535);return(g>>>16)+(p>>>16)+(m>>>16)<<16|m&65535},o=encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(g,p)=>String.fromCharCode(parseInt(p,16))),a=o.length,c=(a+8>>>6)+1,u=new Array(c*16).fill(0);for(n=0;n<a;)u[n>>>2]|=o.charCodeAt(n)<<n%4*8,n++;u[a>>>2]|=128<<a%4*8,u[c*16-2]=a*8;let d=1732584193,l=4023233417,R=2562383102,_=271733878,I=0;for(;I<u.length;){let g=u.slice(I,I+16),[p,m,j,$]=[d,l,R,_];for(n=0;n<16;){let x=m&j|~m&$;p=s(p,s(s(x,g[n]),r[n])),p=i(p,e[0][n%4]),p=s(p,m),[p,m,j,$]=[$,p,m,j],n++}for(n=0;n<16;){let x=$&m|~$&j,T=(5*n+1)%16;p=s(p,s(s(x,g[T]),r[n+16])),p=i(p,e[1][n%4]),p=s(p,m),[p,m,j,$]=[$,p,m,j],n++}for(n=0;n<16;){let x=m^j^$,T=(3*n+5)%16;p=s(p,s(s(x,g[T]),r[n+32])),p=i(p,e[2][n%4]),p=s(p,m),[p,m,j,$]=[$,p,m,j],n++}for(n=0;n<16;){let x=j^(m|~$),T=7*n%16;p=s(p,s(s(x,g[T]),r[n+48])),p=i(p,e[3][n%4]),p=s(p,m),[p,m,j,$]=[$,p,m,j],n++}d=s(d,p),l=s(l,m),R=s(R,j),_=s(_,$),I+=16}let b=g=>{let p="",m=0;for(;m<4;){let j=g>>>m*8&255;p+=(j<16?"0":"")+j.toString(16),m++}return p};return b(d)+b(l)+b(R)+b(_)}function de(...t){var d;if(!t.length)return".";let e=/^[a-zA-Z]:[\\/]/,r=t.some(l=>e.test(l)),n=r?(d=t.find(l=>e.test(l)))==null?void 0:d.charAt(0).toUpperCase():null,i=t.join("/").replace(/\\/g,"/").replace(/\/+/g,"/"),s=/^(?:\/|[a-zA-Z]:\/)/.test(i),o=i.split("/"),a=[],c=0;for(;c<o.length;){let l=o[c++];!l||l==="."||(l===".."&&a.length&&a[a.length-1]!==".."?a.pop():a.push(l))}let u=a.join("/");return r&&n?(u=u.replace(/^[a-zA-Z]:/,"").replace(/^\//,""),u=`${n}:\\${u.replace(/\//g,"\\")}`.replace(/\\+/g,"\\"),u||"."):s?`/${u.replace(/^\//,"")}`:u||"."}var F=(t,e,r)=>{if(!e)return e;let n=e.replace(/\\/g,"/").replace(/\/+/g,"/"),i=(t.root||".").replace(/\\/g,"/").replace(/\/$/,""),s=/^(?:\/|[a-zA-Z]:\/)/.test(n),o=/^[a-zA-Z]:\//.test(n),a=Object.entries(t.aliases),c=a.length-1;for(;c>0;){let l=0;for(;l<c;)a[l][0].length<a[l+1][0].length&&([a[l],a[l+1]]=[a[l+1],a[l]]),l++;c--}let u=0;for(;u<a.length;){let[l,R]=a[u],_=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`^${_}`).test(e)){n=de(R,e.slice(l.length));break}u++}if(!/^(?:\/|[a-zA-Z]:\/)/.test(n)&&!o){let l=r?r.replace(/\\/g,"/").replace(/\/[^/]*$/,""):i;n=de(l,n)}if(t.extension&&!/\.[^/.]+$/.test(n)){let l=t.extension.charAt(0)==="."?t.extension:`.${t.extension}`;n+=l}return n.replace(/\/+/g,"/")};var fe=Object.getPrototypeOf(()=>f(null,null,function*(){})).constructor;function ee(t){return typeof t!="string"?t:t.replace(/^['"`]+|['"`]+$/g,"").trim()}function ge(t){return`(await(async($ejb) => {${t}; return $ejb.res})({...$ejb, res:''}))`}function me(i,s){return f(this,arguments,function*(t,e,r=!1,n=[]){return e.length?(yield Promise.all(e.map(a=>Me(t,a,r,n)))).join(""):""})}function Me(i,s,o){return f(this,arguments,function*(t,e,r,n=[]){return r?te(t,e,n):U(t,e,n)})}function te(t,e,r=[]){switch(e.type){case 0:return me(t,e.children,!0,r);case 1:return N(e.value);case 2:return e.expression;default:return""}}function U(n,i){return f(this,arguments,function*(t,e,r=[]){switch(e.type){case 0:return me(t,e.children,!1,r);case 1:return`$ejb.res += \`${N(e.value)}\`;
`;case 2:{let{expression:s,escaped:o}=e;return`$ejb.res += ${o?`$ejb.escapeHtml(${s})`:s};
`}case 3:case 4:return Ue(t,e,r);default:return""}})}function G(t,e,r,n){return f(this,null,function*(){try{return(yield Promise.resolve(e(...r)))||""}catch(i){let s=i instanceof Error?i:new Error(String(i));return s.loc=n,t.errors.push(s),""}})}function Ue(t,e,r){return f(this,null,function*(){var I,b;let{name:n,expression:i,children:s=[],loc:o}=e,a=e.type===4,c=a?(b=(I=t.directives[e.parent_name])==null?void 0:I.parents)==null?void 0:b.find(g=>g.name===n):t.directives[n];if(!c){let g=new Error(a?`[EJB] Sub-directive "${n}" not found in parent "${e.parent_name}"`:`[EJB] Directive not found: ${n}`);return g.loc=o,t.errors.push(g),""}if(typeof c.name!="string"){let g=c.onNameResolver&&c.name.exec(i);if(g&&c.onNameResolver){let p=yield G(t,c.onNameResolver,[t,g],o);return`$ejb.res += ${JSON.stringify(p||"")};`}return""}let u=xe(i,c.params||[]),d=[...r,...s.filter(g=>g.type===4)],l="";c.onInit&&(l+=yield G(t,c.onInit,[t,u,o],o)),c.onParams&&(l+=yield G(t,c.onParams,[t,u,o],o));let[R,_]=[s.filter(g=>g.type!==4),s.filter(g=>g.type===4)];return R.length&&(l+=c.onChildren?yield G(t,c.onChildren,[t,{children:R,parents:d}],o):yield me(t,R,!1,d)),_.length&&(l+=(yield Promise.all(_.map(g=>U(t,g,d)))).join("")),c.onEnd&&(l+=yield G(t,c.onEnd,[t],o)),l})}function re(t,e){return f(this,null,function*(){let r=Object.values(t.directives).filter(o=>o.onInitFile||o.onEndFile),[n,i]=yield Promise.all([Promise.all(r.filter(o=>o.onInitFile).map(o=>{var a;return Promise.resolve(((a=o.onInitFile)==null?void 0:a.call(o,t))||"")})),Promise.all(r.filter(o=>o.onEndFile).map(o=>{var a;return Promise.resolve(((a=o.onEndFile)==null?void 0:a.call(o,t))||"")}))]),s=t.globalexpose&&Object.keys(t.globals).length?`const { ${Object.keys(t.globals).join(", ")} } = ${t.globalvar};
`:"";return`${n.join(`
`)}
${s}${yield U(t,e)}${i.join(`
`)}
return $ejb;`})}function k(t,e,r){return{line:t,column:e,offset:r}}function S(t,e){var R,_,I;let r=1,n=1,i=0,s={type:0,children:[],errors:[],loc:{start:k(1,1,0),end:k(1,1,e.length)}},o=[s],[a,c]=q.split("*"),u=Object.values(t.directives).filter(b=>typeof b.name!="string"),d=b=>{let g=b.split(`
`);g.length>1?(r+=g.length-1,n=g[g.length-1].length+1):n+=b.length,i+=b.length},l=b=>({start:b,end:k(r,n,i)});for(;i<e.length;){let b=o[o.length-1];if(!b)break;let g=k(r,n,i),p=e.substring(i),m=p.indexOf("@"),j=p.indexOf(a),$=p.indexOf("@@"),x=null;for(let y of u){let w=p.match(y.name);(w==null?void 0:w.index)!==void 0&&(!x||w.index<x.index)&&(x={index:w.index,length:w[0].length,directive:y,match:w})}let T=[m!==-1&&m,j!==-1&&j,x==null?void 0:x.index,$!==-1&&$].filter(y=>y!==!1&&y!==void 0),L=T.length?Math.min(...T):1/0;if(L>0){let y=p.substring(0,L);b.children.push({type:1,value:y,loc:l(g)}),d(y);continue}if(L===1/0){p.length>0&&(b.children.push({type:1,value:p,loc:l(g)}),d(p));break}let D=k(r,n,i);if(L===$){d("@@");let y=e.substring(i).match(Q);y?(b.children.push({type:1,value:"@@"+y[0],loc:l(D)}),d(y[0])):b.children.push({type:1,value:"@@",loc:l(D)});continue}if(x&&L===x.index){let{directive:y,match:w}=x,P={type:3,name:y.name.toString(),expression:w[0],children:[],auto_closed:!1,loc:l(D)};b.children.push(P),d(w[0]),y.children&&o.push(P);continue}if(L===j){d(a);let y=e.indexOf(c,i);if(y===-1){let P=new Error("Unclosed interpolation expression");P.loc=l(D),s.errors.push(P);break}let w=e.substring(i,y).trim();b.children.push({type:2,expression:w,escaped:!0,loc:l(D)}),d(e.substring(i,y+c.length));continue}if(L===m){d("@");let y=e.substring(i).match(Q);if(!y){let E=new Error("Invalid directive");E.loc=l(D),s.errors.push(E);continue}let[w,P,Ie=""]=y,he=Ie.trim(),B=null,O=!1;for(let E=o.length-1;E>=0;E--){let A=o[E];if(A.type===3||A.type===4){let C=t.directives[A.name];if((R=C==null?void 0:C.parents)!=null&&R.some(Ce=>Ce.name===P)){B=A,O=!0;break}}}let ne=!1;if(!O)if(P==="end")ne=!0;else for(let E=o.length-1;E>0;E--){let A=o[E];if(A.type!==0&&A.name===P){ne=!0;break}}if(ne){if(d(w),o.length===1){let E=new Error(`Unexpected ${"@"}${P} directive`);E.loc=l(D),s.errors.push(E);continue}if(P==="end"){let E=o.pop();E!=null&&E.loc&&(E.loc.end=l(D).end)}else{let E=o.findLastIndex((A,C)=>C>0&&A.type!==0&&A.name===P);if(E===-1){let A=new Error(`No matching ${"@"}${P} directive to close`);A.loc=l(D),s.errors.push(A);continue}for(let A=o.length-1;A>=E;A--){let C=o[A];C!=null&&C.loc&&(C.loc.end=l(D).end)}o.length=E}continue}let se=O?(I=(_=t.directives[B==null?void 0:B.name])==null?void 0:_.parents)==null?void 0:I.find(E=>E.name===P):t.directives[P],ie=l(D);ie.end=k(r,n+w.length,i+w.length);let oe=O?{type:4,name:P,expression:he,children:[],auto_closed:!1,parent_name:B==null?void 0:B.name,loc:ie}:{type:3,name:P,expression:he,children:[],auto_closed:!1,loc:ie};d(w),O&&B?B.children.push(oe):b.children.push(oe),se&&(O||se.children===!0||"internal"in se)&&o.push(oe)}}for(;o.length>1;){let b=o.pop();b.auto_closed=!0,b.loc&&(b.loc.end=k(r,n,i))}return s.loc&&(s.loc.end=k(r,n,i)),s}var we=h({name:"component",priority:10,children:!0,params:[{name:"path",type:"string",required:!0},{name:"variables",type:"object",default:"{}"}],parents:[{name:"slot",internal:!0,onParams:(t,e)=>`$slots["$" + ${e.raw}] = await (async ($ejb) => {`,onEnd:()=>`
return $ejb.res;})({ ...$ejb, res:'' });`}],onInit:()=>`$ejb.res += await (async ($ejb) => { const $slots = {};
`,onEnd:()=>"return $_component($_import, {...$_variables, ...$slots}); })( { ...$ejb, res:'' });",onChildren:(n,i)=>f(null,[n,i],function*(t,{children:e,parents:r}){let s=yield t.compile(e),o=yield t.compile(r!=null?r:[]);return`$slots.$slot = ${ge(s)} ?? "";
 ${o!=null?o:""}
`}),onParams:(t,e)=>f(null,null,function*(){let r=e.getString("path"),n=e.getRaw("variables");if(!r)throw new Error("[EJB] @component directive requires a path.");if(!t.resolver)throw new Error("[EJB] @ directive requires a resolver to be configured.");try{let i=yield t.resolver(F(t,r)),s=S(t,i),o=yield t.compile(s);return["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${t.globalvar}, ...(${n}) };`,`const $_component = new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${N(o)}\\nreturn $ejb.res;\`);
`].join(`
`)}catch(i){return console.error(`[EJB] Failed to resolve import for path: ${r}`,i),`return \`<!-- EJB Import Error: ${N(i.message)} -->\`;`}})});var Pe=h({name:"import",priority:10,children:!1,description:"Imports and renders another EJB template file.",example:"@import('./path/to/template.ejb', { myVar: 'value' })",params:[{name:"path",type:"string",required:!0},{name:"variables",type:"object",default:"{}"}],onInit:()=>" $ejb.res += await (async ($ejb) => {",onEnd:()=>" })( { ...$ejb, res:'' });",onParams:(t,e)=>f(null,null,function*(){let r=e.getString("path"),n=e.getRaw("variables");if(!r)throw new Error("[EJB] @import directive requires a path.");if(!t.resolver)throw new Error("[EJB] @import directive requires a resolver to be configured.");try{let i=yield t.resolver(F(t,r)),s=S(t,i),o=yield t.compile(s);return["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${t.globalvar}, ...(${n}) };`,`return new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${N(o)}\\nreturn $ejb.res;\`)($_import, $_variables)`].join(`
`)}catch(i){return t.errors.push(i),""}})});var Ae=Object.assign({},h({name:"stack",priority:1,onInitFile:()=>`$ejb._stacks = {};

        $ejb.stacks = new Proxy({}, {
            get(target, prop) {
                if(!$ejb._stacks[prop]) $ejb._stacks[prop] = [];
                if (!(prop in target)) {
                    target[prop] = {
                        add(item) {
                            $ejb._stacks[prop].push(item);
                            return this;
                        },
                        join(separator = ",") {
                            return $ejb._stacks[prop].join(separator);
                        }
                    };
                }
                return target[prop];
            }
        });
`,onParams(t,e){return`$ejb.res = $ejb._stacks[${e.raw}] ? ($ejb.res + $ejb.stacks[${e.raw}].join('\\n')) : ($ejb.res + '<!-- EJB:stack(${ee(e.raw)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.stacks).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:stack(\${pushname}) -->\`).join($ejb.stacks[pushname].join('\\n'));
                });
    
                // remove not used stacks
                $ejb.res = $ejb.res.replace(/<!-- EJB:stack\\(.*?\\) -->/g, '');`}),h({name:"push",priority:1,children:!0,onInit:(t,e)=>`$ejb.stacks[${e.raw}].add(await (async ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' }));"}),h({name:"defined",priority:11,onInitFile:()=>"$ejb.defines = {};",onParams(t,e){return`$ejb.res = $ejb.defines[${e.raw}] ? ($ejb.res + $ejb.defines[${e.raw}]) : ($ejb.res + '<!-- EJB:defines(${ee(e.raw)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.defines).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:defines(\${pushname}) -->\`).join($ejb.defines[pushname]);
                });
    
                // remove not used defines
                $ejb.res = $ejb.res.replace(/<!-- EJB:defines\\(.*?\\) -->/g, '');`}),h({name:"define",priority:11,children:!0,onInit:(t,e)=>`$ejb.defines[${e.raw}] = await (async ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' });"}));var _e=Object.assign({},h({name:"const",priority:1,onParams:(t,e)=>`const ${e.raw};`}),h({name:"let",priority:1,onParams:(t,e)=>{if("res"in t&&typeof t.res=="function"){let r=`let ${e.raw};`;return t.res(r),""}return`let ${e.raw};`}}),h({name:"code",priority:1,children:!0,onChildren:(r,n)=>f(null,[r,n],function*(t,{children:e}){return yield t.compile(e,!0)})}),h({name:"if",priority:1,children:!0,onParams:(t,e)=>`if (${e.raw}) {`,onEnd:()=>"}",parents:[{name:"elseif",internal:!0,onInit:(t,e)=>`} else if (${e.raw}) {`,onEnd:()=>"}"},{name:"elif",internal:!0,onInit:(t,e)=>`} else if (${e.raw}) {`,onEnd:()=>"}"},{name:"else",internal:!0,onInit:()=>"else {"}]}),h({name:"for",priority:1,children:!0,onInit:(t,e)=>`for (${e.raw}) {`,onEnd:()=>"}"}),h({name:"isset",priority:1,onParams(t,e){return`if(typeof ${e.raw} !== "undefined" && ${e.raw}) $ejb.res += ${e.raw};`}}),h({name:"switch",priority:1,children:!0,onParams:(t,e)=>`switch (${e.raw}) {`,parents:[{name:"case",internal:!0,onInit:(t,e)=>`case ${e.raw}: {`,onEnd:()=>";break;};"},{name:"default",internal:!0,onInit:()=>"default: {",onEnd:()=>"};"}],onChildren:()=>f(null,null,function*(){return""}),onEnd:()=>"}"}),h({name:"once",priority:1,children:!0,onInitFile:()=>"$ejb.onces = {};",onChildren:(t,e)=>f(null,null,function*(){let r=yield t.compile(e.children),n=V(r);return`if(typeof $ejb.onces['${n}'] == "undefined") {
                $ejb.onces['${n}'] = true;
                ${r}
                `}),onEnd:()=>"};"}));var Re=Object.assign({},h({name:"client",priority:1,children:!0,description:"Defines code that should only run on the client side",example:"@client const handler = () => console.log('clicked'); @end",children_type:"js",onChildren:(r,n)=>f(null,[r,n],function*(t,{children:e}){if("res"in t&&typeof t.res=="function"){let i=t,s=yield i.compile(e,!0);return i.res(s,"client"),""}return yield t.compile(e,!0)})}),h({name:"server",priority:1,children:!0,description:"Defines code that should only run on the server side",example:"@server const data = await fetchFromDB(); @end",children_type:"js",onChildren:(r,n)=>f(null,[r,n],function*(t,{children:e}){if("res"in t&&typeof t.res=="function"){let i=t,s=yield i.compile(e,!0);return i.res(s,"server"),""}return yield t.compile(e,!0)})}),h({name:"style",priority:1,children:!0,description:"Defines CSS styles for the component",example:"@style .button { background: blue; } @end",children_type:"css",onChildren:(r,n)=>f(null,[r,n],function*(t,{children:e}){if("res"in t&&typeof t.res=="function"){let i=t,s=yield i.compile(e,!0);return i.res(s,"css"),""}return""})}),h({name:"hydrate",priority:1,children:!0,description:"Marks content for client-side hydration",example:"@hydrate <button onclick='handleClick()'>Click</button> @end",onInit:t=>{if("res"in t&&typeof t.res=="function"){let e=t,r=`hydrate-${Math.random().toString(36).substring(7)}`;return e.res(`$ejb.res += '<div data-hydrate="${r}">';`,"server"),e.res(`document.querySelector('[data-hydrate="${r}"]').innerHTML = `,"client"),""}return"$ejb.res += '<div>';"},onEnd:t=>{if("res"in t&&typeof t.res=="function"){let e=t;return e.res("$ejb.res += '</div>';","server"),e.res(";","client"),""}return"$ejb.res += '</div>';"}}),h({name:"asset",priority:1,description:"Includes client-side assets (JS/CSS)",example:"@asset('script', 'main')",params:[{name:"type",type:"string",required:!0},{name:"name",type:"string",required:!0}],onParams:(t,e)=>f(null,null,function*(){if("getAssets"in t){let r=t,n=e.getString("type"),i=e.getString("name"),s=r.current;if(!s)throw new Error("[EJB] No current file set for @asset");let a=(yield r.getAssets(s)).find(c=>n==="script"?c.startsWith("cl-")&&c.endsWith(".js"):n==="style"?c.startsWith("st-")&&c.endsWith(".css"):!1);if(a)return`$ejb.res += \`${n==="script"?`<script src="/${a}"></script>`:`<link rel="stylesheet" href="/${a}">`}\`;`}return""})}));var Ne=Object.assign({},Pe,we,Ae,_e,Re);var z=class{constructor(e={}){this.errors=[];this.getFunction=()=>fe;this.directives={};var r,n,i,s,o,a,c;this.aliases=(r=e.aliases)!=null?r:{},this.extension=(n=e.extension)!=null?n:"ejb",this.globals=(i=e.globals)!=null?i:{},this.root=(s=e.root)!=null?s:"./",this.globalexpose=(o=e.globalexpose)!=null?o:!0,this.resolver=(a=e.resolver)!=null?a:(u=>{let d=`[EJB]: Resolver not defined, but was required for path: ${u}`;return Promise.reject(new Error(d))}),this.directives=Object.assign({},Ne,e.directives),this.globalvar=(c=e==null?void 0:e.globalvar)!=null?c:"it"}makeFunction(e){return f(this,null,function*(){this.errors=[];let r=this.isTemplatePath(e),n=i=>f(this,null,function*(){let s=S(this,i);s.errors.length&&this.errors.push(...s.errors);let o=yield re(this,s);return(c=>this.errors.length>0?`return () => { const err = new Error('EJB compilation failed'); err.details = ${JSON.stringify(this.errors.map(d=>({message:d.stack||d.message,loc:d.loc})))}; throw err; }`:`
                return function(${this.globalvar}) {
                    const $ejb = {
                        ins: this,
                        res: '',
                        escapeHtml: ${Y.toString()},
                        escapeJs: ${N.toString()},
                        EjbFunction: async function() { 
                            return new (async () => {}).constructor.apply(null, arguments);
                        }
                    };
                    
                    ${c}
                }.bind(this);
            `)(o)});if(r)try{let i=F(this,e),s=yield Promise.resolve(this.resolver(i));return n(s)}catch(i){if(i&&typeof i=="object"&&"code"in i&&i.code==="ENOENT")return console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`),n(e);throw i}return n(e)})}compile(e,r=!1){return f(this,null,function*(){let n=Array.isArray(e)?e:[e],i=r?te:U;return(yield Promise.all(n.map(o=>i(this,o)))).join("")})}parser(e){return S(this,e)}render(n){return f(this,arguments,function*(e,r={}){if(this.errors=[],this.isTemplatePath(e))try{let u=F(this,e);e=yield Promise.resolve(this.resolver(u))}catch(u){if(u&&typeof u=="object"&&"code"in u&&u.code==="ENOENT")console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`);else throw u}let s=S(this,e);s.errors.length&&this.errors.push(...s.errors);let o=yield re(this,s),a=u=>new(this.getFunction())("$ejb",this.globalvar,u)({ins:this,res:"",escapeHtml:Y,escapeJs:N,escapeString:pe,EjbFunction:this.getFunction()},M(M({},this.globals),r));if(this.errors.length>0){let u=this.errors.map(d=>d.stack||d.message).join(`

`);return this.errors=[],u}return(yield a(o)).res})}isTemplatePath(e){let r=e.trim();if(r.includes(`
`))return!1;let[n]=q.split("*");return r.includes(n)||new RegExp(`^s*${ue("@")}`).test(r)||le.test(r)?!1:r.includes("/")||r.includes("\\")||r.startsWith("@/")||r.startsWith("@\\")}register(...e){let r=e.map(n=>Object.keys(n).length===1?n:h(n));return this.directives=Object.assign(this.directives,...r),this}};var be=class extends z{constructor(r={}){var n;super(r);this.files={};this._currentFile="";this._currentLoader="server";this.dist=(n=r.dist)!=null?n:"./dist"}file(r){return this._currentFile=r,this.files[r]||(this.files[r]=[]),this}get current(){return this._currentFile}load(r){return this._currentLoader=r,this}get loader(){return this._currentLoader}res(r,n=this._currentLoader){if(!this._currentFile)throw new Error("[EJB] No file set. Call file() first.");let i=this.files[this._currentFile],s=i.find(o=>o.loader===n);s||(s={loader:n,content:""},i.push(s)),s.content+=r}build(){return f(this,null,function*(){var n;let r={paths:{}};for(let[i,s]of Object.entries(this.files)){let o=[];for(let{loader:a,content:c}of s){let u=V(c).substring(0,8),d=a==="server"?"se":a==="client"?"cl":"st",l=a==="css"?"css":"js",R=((n=i.split("/").pop())==null?void 0:n.replace(/\.ejb$/,""))||"file",_=`${d}-${R}.${u}.${l}`;yield(0,H.writeFile)((0,W.join)(this.dist,_),c,"utf-8"),a==="server"?r.paths[i]={entry:_,assets:[]}:o.push(_)}r.paths[i]&&(r.paths[i].assets=o)}return yield(0,H.writeFile)((0,W.join)(this.dist,"ejb.json"),JSON.stringify(r,null,2),"utf-8"),this.manifest=r,r})}loadManifest(){return f(this,null,function*(){if(this.manifest)return this.manifest;try{let r=yield(0,H.readFile)((0,W.join)(this.dist,"ejb.json"),"utf-8"),n=JSON.parse(r);return this.manifest=n,n}catch(r){throw new Error(`[EJB] Failed to load manifest from ${this.dist}/ejb.json`)}})}getEntry(r){return f(this,null,function*(){var i;return(i=(yield this.loadManifest()).paths[r])==null?void 0:i.entry})}getAssets(r){return f(this,null,function*(){var i;return((i=(yield this.loadManifest()).paths[r])==null?void 0:i.assets)||[]})}renderBuilt(i){return f(this,arguments,function*(r,n={}){let s=yield this.getEntry(r);if(!s)throw new Error(`[EJB] No entry found for ${r}`);let o=(0,W.join)(this.dist,s),a=yield(0,H.readFile)(o,"utf-8");return(yield new De("$ejb",this.globalvar,a)({ins:this,res:"",escapeHtml:d=>d.replace(/[&<>"']/g,l=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[l]||l),escapeJs:d=>d.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$\{/g,"\\${"),EjbFunction:De},M(M({},this.globals),n))).res})}compileFile(r){return f(this,null,function*(){this.file(r);let n=yield this.resolver(r),i=S(this,n);if(i.errors.length){this.errors.push(...i.errors);return}for(let s of["server","client","css"]){this.load(s);let o=yield this.compile(i);this.res(o,s)}})}},De=Object.getPrototypeOf(()=>f(null,null,function*(){})).constructor;var Se=require("fs/promises");var He=()=>t=>(0,Se.readFile)(t,{encoding:"utf-8"}),Xe=t=>f(null,null,function*(){try{let e=Bun.file(t);return(yield e.exists())?yield e.text():""}catch(e){return console.error(`[EJB-IMPORT] Failed to resolve: ${t}`,e),""}});0&&(module.exports={AsyncFunction,DIRECTIVE_REGEX,EJBBunResolver,EJBNodeJSResolver,EJB_DEFAULT_PREFIX_DIRECTIVE,EJB_DEFAULT_PREFIX_GLOBAL,EJB_DEFAULT_PREFIX_VARIABLE,EJB_ESCAPED_PREFIX_DIRECTIVE,ESCAPE_HTML,ESPACE_HTML_REGEX,Ejb,EjbAst,EjbBuilder,HTML_REGULAR_REGEX,compile,ejbDirective,ejbParser,escapeHtml,escapeJs,escapeRegExp,escapeString,filepathResolver,generateNodeCode,generateNodeString,join,md5,returnEjbRes,trimQuotes});
