import{readFile as Ee,writeFile as ye}from"fs/promises";import{join as U}from"path";var te="it",C="@",B="@@",L="{{*}}",re={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},ne=/[&<>"'']/g,se=/<[a-z][\s\S]*>/i,G=/^\s*([a-zA-Z0-9]+)(?:\s*\(([\s\S]*?)\))?/,z=(s=>(s[s.Root=0]="Root",s[s.Text=1]="Text",s[s.Interpolation=2]="Interpolation",s[s.Directive=3]="Directive",s[s.SubDirective=4]="SubDirective",s))(z||{});function b(t){return{[t.name.toString()]:t}}function xe(t){let e=[],n=0,r=0,i=!1;for(let o=0;o<t.length;o++){let a=t[o];if(i){a===i&&t[o-1]!=="\\"&&(i=!1);continue}switch(a){case"`":case"'":case'"':i=a;break;case"(":case"[":case"{":n++;break;case")":case"]":case"}":n--;break;case",":if(n===0){let c=t.substring(r,o).trim();c&&e.push(c),r=o+1}break}}let s=t.substring(r).trim();return s&&e.push(s),e}function ie(t){try{return new Function(`return ${t}`)()}catch{return}}function oe(t,e){let n=xe(t),r=new Map(e.map(a=>[a.name,a])),i=a=>{let c=e.findIndex(d=>d.name===a);return c>=0?n[c]:void 0},s=a=>{let c=i(a);return c!==void 0?c:r.get(a)?.default},o=a=>({raw:i(a),string:s(a)?.replace(/^["'`]|["'`]$/g,""),number:()=>{let c=s(a);return c!==void 0?parseFloat(c):void 0},boolean:()=>{let c=s(a);return c!==void 0?c==="true":void 0},object:()=>ie(s(a)||""),array:()=>ie(s(a)||"")});return{raw:t,getRaw:a=>o(a).raw,getString:a=>o(a).string,getNumber:a=>o(a).number(),getBoolean:a=>o(a).boolean(),getObject:a=>o(a).object(),getArray:a=>o(a).array()}}function ae(t){return t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}function ce(t){return typeof t!="string"?t:t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f").replace(/\b/g,"\\b").replace(/\v/g,"\\v")}var D=t=>t.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$\{/g,"\\${");function W(t){return t==null?"":String(t).replace(ne,e=>re[e])}function O(t){let e=[[7,12,17,22],[5,9,14,20],[4,11,16,23],[6,10,15,21]],n=[],r=0;for(;r<64;)n[r]=Math.floor(Math.abs(Math.sin(r+1))*4294967296)>>>0,r++;let i=(j,l)=>j<<l|j>>>32-l,s=(j,l)=>{let f=(j&65535)+(l&65535);return(j>>>16)+(l>>>16)+(f>>>16)<<16|f&65535},o=encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(j,l)=>String.fromCharCode(parseInt(l,16))),a=o.length,c=(a+8>>>6)+1,d=new Array(c*16).fill(0);for(r=0;r<a;)d[r>>>2]|=o.charCodeAt(r)<<r%4*8,r++;d[a>>>2]|=128<<a%4*8,d[c*16-2]=a*8;let p=1732584193,u=4023233417,m=2562383102,w=271733878,g=0;for(;g<d.length;){let j=d.slice(g,g+16),[l,f,$,E]=[p,u,m,w];for(r=0;r<16;){let v=f&$|~f&E;l=s(l,s(s(v,j[r]),n[r])),l=i(l,e[0][r%4]),l=s(l,f),[l,f,$,E]=[E,l,f,$],r++}for(r=0;r<16;){let v=E&f|~E&$,h=(5*r+1)%16;l=s(l,s(s(v,j[h]),n[r+16])),l=i(l,e[1][r%4]),l=s(l,f),[l,f,$,E]=[E,l,f,$],r++}for(r=0;r<16;){let v=f^$^E,h=(3*r+5)%16;l=s(l,s(s(v,j[h]),n[r+32])),l=i(l,e[2][r%4]),l=s(l,f),[l,f,$,E]=[E,l,f,$],r++}for(r=0;r<16;){let v=$^(f|~E),h=7*r%16;l=s(l,s(s(v,j[h]),n[r+48])),l=i(l,e[3][r%4]),l=s(l,f),[l,f,$,E]=[E,l,f,$],r++}p=s(p,l),u=s(u,f),m=s(m,$),w=s(w,E),g+=16}let R=j=>{let l="",f=0;for(;f<4;){let $=j>>>f*8&255;l+=($<16?"0":"")+$.toString(16),f++}return l};return R(p)+R(u)+R(m)+R(w)}function le(...t){if(!t.length)return".";let e=/^[a-zA-Z]:[\\/]/,n=t.some(p=>e.test(p)),r=n?t.find(p=>e.test(p))?.charAt(0).toUpperCase():null,i=t.join("/").replace(/\\/g,"/").replace(/\/+/g,"/"),s=/^(?:\/|[a-zA-Z]:\/)/.test(i),o=i.split("/"),a=[],c=0;for(;c<o.length;){let p=o[c++];!p||p==="."||(p===".."&&a.length&&a[a.length-1]!==".."?a.pop():a.push(p))}let d=a.join("/");return n&&r?(d=d.replace(/^[a-zA-Z]:/,"").replace(/^\//,""),d=`${r}:\\${d.replace(/\//g,"\\")}`.replace(/\\+/g,"\\"),d||"."):s?`/${d.replace(/^\//,"")}`:d||"."}var N=(t,e,n)=>{if(!e)return e;let r=e.replace(/\\/g,"/").replace(/\/+/g,"/"),i=(t.root||".").replace(/\\/g,"/").replace(/\/$/,""),s=/^(?:\/|[a-zA-Z]:\/)/.test(r),o=/^[a-zA-Z]:\//.test(r),a=Object.entries(t.aliases),c=a.length-1;for(;c>0;){let u=0;for(;u<c;)a[u][0].length<a[u+1][0].length&&([a[u],a[u+1]]=[a[u+1],a[u]]),u++;c--}let d=0;for(;d<a.length;){let[u,m]=a[d],w=u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`^${w}`).test(e)){r=le(m,e.slice(u.length));break}d++}if(!/^(?:\/|[a-zA-Z]:\/)/.test(r)&&!o){let u=n?n.replace(/\\/g,"/").replace(/\/[^/]*$/,""):i;r=le(u,r)}if(t.extension&&!/\.[^/.]+$/.test(r)){let u=t.extension.charAt(0)==="."?t.extension:`.${t.extension}`;r+=u}return r.replace(/\/+/g,"/")};var ue=Object.getPrototypeOf(async()=>{}).constructor;function Z(t){return typeof t!="string"?t:t.replace(/^['"`]+|['"`]+$/g,"").trim()}function pe(t){return`(await(async($ejb) => {${t}; return $ejb.res})({...$ejb, res:''}))`}async function Q(t,e,n=!1,r=[]){return e.length?(await Promise.all(e.map(s=>Pe(t,s,n,r)))).join(""):""}async function Pe(t,e,n,r=[]){return n?K(t,e,r):J(t,e,r)}function K(t,e,n=[]){switch(e.type){case 0:return Q(t,e.children,!0,n);case 1:return D(e.value);case 2:return e.expression;default:return""}}async function J(t,e,n=[]){switch(e.type){case 0:return Q(t,e.children,!1,n);case 1:return`$ejb.res += \`${D(e.value)}\`;
`;case 2:{let{expression:r,escaped:i}=e;return`$ejb.res += ${i?`$ejb.escapeHtml(${r})`:r};
`}case 3:case 4:return _e(t,e,n);default:return""}}async function k(t,e,n,r){try{return await Promise.resolve(e(...n))||""}catch(i){let s=i instanceof Error?i:new Error(String(i));return s.loc=r,t.errors.push(s),""}}async function _e(t,e,n){let{name:r,expression:i,children:s=[],loc:o}=e,a=e.type===4,c=a?t.directives[e.parent_name]?.parents?.find(g=>g.name===r):t.directives[r];if(!c){let g=new Error(a?`[EJB] Sub-directive "${r}" not found in parent "${e.parent_name}"`:`[EJB] Directive not found: ${r}`);return g.loc=o,t.errors.push(g),""}if(typeof c.name!="string"){let g=c.onNameResolver&&c.name.exec(i);if(g&&c.onNameResolver){let R=await k(t,c.onNameResolver,[t,g],o);return`$ejb.res += ${JSON.stringify(R||"")};`}return""}let d=oe(i,c.params||[]),p=[...n,...s.filter(g=>g.type===4)],u="";c.onInit&&(u+=await k(t,c.onInit,[t,d,o],o)),c.onParams&&(u+=await k(t,c.onParams,[t,d,o],o));let[m,w]=[s.filter(g=>g.type!==4),s.filter(g=>g.type===4)];return m.length&&(u+=c.onChildren?await k(t,c.onChildren,[t,{children:m,parents:p}],o):await Q(t,m,!1,p)),w.length&&(u+=(await Promise.all(w.map(g=>J(t,g,p)))).join("")),c.onEnd&&(u+=await k(t,c.onEnd,[t],o)),u}async function Y(t,e){let n=Object.values(t.directives).filter(o=>o.onInitFile||o.onEndFile),[r,i]=await Promise.all([Promise.all(n.filter(o=>o.onInitFile).map(o=>Promise.resolve(o.onInitFile?.(t)||""))),Promise.all(n.filter(o=>o.onEndFile).map(o=>Promise.resolve(o.onEndFile?.(t)||"")))]),s=t.globalexpose&&Object.keys(t.globals).length?`const { ${Object.keys(t.globals).join(", ")} } = ${t.globalvar};
`:"";return`${r.join(`
`)}
${s}${await J(t,e)}${i.join(`
`)}
return $ejb;`}function A(t,e,n){return{line:t,column:e,offset:n}}function I(t,e){let n=1,r=1,i=0,s={type:0,children:[],errors:[],loc:{start:A(1,1,0),end:A(1,1,e.length)}},o=[s],[a,c]=L.split("*"),d=Object.values(t.directives).filter(m=>typeof m.name!="string"),p=m=>{let w=m.split(`
`);w.length>1?(n+=w.length-1,r=w[w.length-1].length+1):r+=m.length,i+=m.length},u=m=>({start:m,end:A(n,r,i)});for(;i<e.length;){let m=o[o.length-1];if(!m)break;let w=A(n,r,i),g=e.substring(i),R=g.indexOf("@"),j=g.indexOf(a),l=g.indexOf("@@"),f=null;for(let h of d){let _=g.match(h.name);_?.index!==void 0&&(!f||_.index<f.index)&&(f={index:_.index,length:_[0].length,directive:h,match:_})}let $=[R!==-1&&R,j!==-1&&j,f?.index,l!==-1&&l].filter(h=>h!==!1&&h!==void 0),E=$.length?Math.min(...$):1/0;if(E>0){let h=g.substring(0,E);m.children.push({type:1,value:h,loc:u(w)}),p(h);continue}if(E===1/0){g.length>0&&(m.children.push({type:1,value:g,loc:u(w)}),p(g));break}let v=A(n,r,i);if(E===l){p("@@");let h=e.substring(i).match(G);h?(m.children.push({type:1,value:"@@"+h[0],loc:u(v)}),p(h[0])):m.children.push({type:1,value:"@@",loc:u(v)});continue}if(f&&E===f.index){let{directive:h,match:_}=f,x={type:3,name:h.name.toString(),expression:_[0],children:[],auto_closed:!1,loc:u(v)};m.children.push(x),p(_[0]),h.children&&o.push(x);continue}if(E===j){p(a);let h=e.indexOf(c,i);if(h===-1){let x=new Error("Unclosed interpolation expression");x.loc=u(v),s.errors.push(x);break}let _=e.substring(i,h).trim();m.children.push({type:2,expression:_,escaped:!0,loc:u(v)}),p(e.substring(i,h+c.length));continue}if(E===R){p("@");let h=e.substring(i).match(G);if(!h){let y=new Error("Invalid directive");y.loc=u(v),s.errors.push(y);continue}let[_,x,we=""]=h,ee=we.trim(),T=null,S=!1;for(let y=o.length-1;y>=0;y--){let P=o[y];if((P.type===3||P.type===4)&&t.directives[P.name]?.parents?.some(je=>je.name===x)){T=P,S=!0;break}}let X=!1;if(!S)if(x==="end")X=!0;else for(let y=o.length-1;y>0;y--){let P=o[y];if(P.type!==0&&P.name===x){X=!0;break}}if(X){if(p(_),o.length===1){let y=new Error(`Unexpected ${"@"}${x} directive`);y.loc=u(v),s.errors.push(y);continue}if(x==="end"){let y=o.pop();y?.loc&&(y.loc.end=u(v).end)}else{let y=o.findLastIndex((P,F)=>F>0&&P.type!==0&&P.name===x);if(y===-1){let P=new Error(`No matching ${"@"}${x} directive to close`);P.loc=u(v),s.errors.push(P);continue}for(let P=o.length-1;P>=y;P--){let F=o[P];F?.loc&&(F.loc.end=u(v).end)}o.length=y}continue}let H=S?t.directives[T?.name]?.parents?.find(y=>y.name===x):t.directives[x],V=u(v);V.end=A(n,r+_.length,i+_.length);let q=S?{type:4,name:x,expression:ee,children:[],auto_closed:!1,parent_name:T?.name,loc:V}:{type:3,name:x,expression:ee,children:[],auto_closed:!1,loc:V};p(_),S&&T?T.children.push(q):m.children.push(q),H&&(S||H.children===!0||"internal"in H)&&o.push(q)}}for(;o.length>1;){let m=o.pop();m.auto_closed=!0,m.loc&&(m.loc.end=A(n,r,i))}return s.loc&&(s.loc.end=A(n,r,i)),s}var de=b({name:"component",priority:10,children:!0,params:[{name:"path",type:"string",required:!0},{name:"variables",type:"object",default:"{}"}],parents:[{name:"slot",internal:!0,onParams:(t,e)=>`$slots["$" + ${e.raw}] = await (async ($ejb) => {`,onEnd:()=>`
return $ejb.res;})({ ...$ejb, res:'' });`}],onInit:()=>`$ejb.res += await (async ($ejb) => { const $slots = {};
`,onEnd:()=>"return $_component($_import, {...$_variables, ...$slots}); })( { ...$ejb, res:'' });",onChildren:async(t,{children:e,parents:n})=>{let r=await t.compile(e),i=await t.compile(n??[]);return`$slots.$slot = ${pe(r)} ?? "";
 ${i??""}
`},onParams:async(t,e)=>{let n=e.getString("path"),r=e.getRaw("variables");if(!n)throw new Error("[EJB] @component directive requires a path.");if(!t.resolver)throw new Error("[EJB] @ directive requires a resolver to be configured.");try{let i=await t.resolver(N(t,n)),s=I(t,i),o=await t.compile(s);return["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${t.globalvar}, ...(${r}) };`,`const $_component = new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${D(o)}\\nreturn $ejb.res;\`);
`].join(`
`)}catch(i){return console.error(`[EJB] Failed to resolve import for path: ${n}`,i),`return \`<!-- EJB Import Error: ${D(i.message)} -->\`;`}}});var fe=b({name:"import",priority:10,children:!1,description:"Imports and renders another EJB template file.",example:"@import('./path/to/template.ejb', { myVar: 'value' })",params:[{name:"path",type:"string",required:!0},{name:"variables",type:"object",default:"{}"}],onInit:()=>" $ejb.res += await (async ($ejb) => {",onEnd:()=>" })( { ...$ejb, res:'' });",onParams:async(t,e)=>{let n=e.getString("path"),r=e.getRaw("variables");if(!n)throw new Error("[EJB] @import directive requires a path.");if(!t.resolver)throw new Error("[EJB] @import directive requires a resolver to be configured.");try{let i=await t.resolver(N(t,n)),s=I(t,i),o=await t.compile(s);return["const $_import = { ...$ejb, res: '' };",`const $_variables = { ...${t.globalvar}, ...(${r}) };`,`return new $ejb.EjbFunction('$ejb', $ejb.ins.globalvar, \`${D(o)}\\nreturn $ejb.res;\`)($_import, $_variables)`].join(`
`)}catch(i){return t.errors.push(i),""}}});var me=Object.assign({},b({name:"stack",priority:1,onInitFile:()=>`$ejb._stacks = {};

        $ejb.stacks = new Proxy({}, {
            get(target, prop) {
                if(!$ejb._stacks[prop]) $ejb._stacks[prop] = [];
                if (!(prop in target)) {
                    target[prop] = {
                        add(item) {
                            $ejb._stacks[prop].push(item);
                            return this;
                        },
                        join(separator = ",") {
                            return $ejb._stacks[prop].join(separator);
                        }
                    };
                }
                return target[prop];
            }
        });
`,onParams(t,e){return`$ejb.res = $ejb._stacks[${e.raw}] ? ($ejb.res + $ejb.stacks[${e.raw}].join('\\n')) : ($ejb.res + '<!-- EJB:stack(${Z(e.raw)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.stacks).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:stack(\${pushname}) -->\`).join($ejb.stacks[pushname].join('\\n'));
                });
    
                // remove not used stacks
                $ejb.res = $ejb.res.replace(/<!-- EJB:stack\\(.*?\\) -->/g, '');`}),b({name:"push",priority:1,children:!0,onInit:(t,e)=>`$ejb.stacks[${e.raw}].add(await (async ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' }));"}),b({name:"defined",priority:11,onInitFile:()=>"$ejb.defines = {};",onParams(t,e){return`$ejb.res = $ejb.defines[${e.raw}] ? ($ejb.res + $ejb.defines[${e.raw}]) : ($ejb.res + '<!-- EJB:defines(${Z(e.raw)}) -->');`},onEndFile:()=>`
                Object.keys($ejb.defines).forEach(pushname => {
                    $ejb.res = $ejb.res.split(\`<!-- EJB:defines(\${pushname}) -->\`).join($ejb.defines[pushname]);
                });
    
                // remove not used defines
                $ejb.res = $ejb.res.replace(/<!-- EJB:defines\\(.*?\\) -->/g, '');`}),b({name:"define",priority:11,children:!0,onInit:(t,e)=>`$ejb.defines[${e.raw}] = await (async ($ejb) => {`,onEnd:()=>";return $ejb.res;})({ ...$ejb, res:'' });"}));var ge=Object.assign({},b({name:"const",priority:1,onParams:(t,e)=>`const ${e.raw};`}),b({name:"let",priority:1,onParams:(t,e)=>{if("res"in t&&typeof t.res=="function"){let n=`let ${e.raw};`;return t.res(n),""}return`let ${e.raw};`}}),b({name:"code",priority:1,children:!0,onChildren:async(t,{children:e})=>await t.compile(e,!0)}),b({name:"if",priority:1,children:!0,onParams:(t,e)=>`if (${e.raw}) {`,onEnd:()=>"}",parents:[{name:"elseif",internal:!0,onInit:(t,e)=>`} else if (${e.raw}) {`,onEnd:()=>"}"},{name:"elif",internal:!0,onInit:(t,e)=>`} else if (${e.raw}) {`,onEnd:()=>"}"},{name:"else",internal:!0,onInit:()=>"else {"}]}),b({name:"for",priority:1,children:!0,onInit:(t,e)=>`for (${e.raw}) {`,onEnd:()=>"}"}),b({name:"isset",priority:1,onParams(t,e){return`if(typeof ${e.raw} !== "undefined" && ${e.raw}) $ejb.res += ${e.raw};`}}),b({name:"switch",priority:1,children:!0,onParams:(t,e)=>`switch (${e.raw}) {`,parents:[{name:"case",internal:!0,onInit:(t,e)=>`case ${e.raw}: {`,onEnd:()=>";break;};"},{name:"default",internal:!0,onInit:()=>"default: {",onEnd:()=>"};"}],onChildren:async()=>"",onEnd:()=>"}"}),b({name:"once",priority:1,children:!0,onInitFile:()=>"$ejb.onces = {};",onChildren:async(t,e)=>{let n=await t.compile(e.children),r=O(n);return`if(typeof $ejb.onces['${r}'] == "undefined") {
                $ejb.onces['${r}'] = true;
                ${n}
                `},onEnd:()=>"};"}));var he=Object.assign({},b({name:"client",priority:1,children:!0,description:"Defines code that should only run on the client side",example:"@client const handler = () => console.log('clicked'); @end",children_type:"js",onChildren:async(t,{children:e})=>{if("res"in t&&typeof t.res=="function"){let n=t,r=await n.compile(e,!0);return n.res(r,"client"),""}return await t.compile(e,!0)}}),b({name:"server",priority:1,children:!0,description:"Defines code that should only run on the server side",example:"@server const data = await fetchFromDB(); @end",children_type:"js",onChildren:async(t,{children:e})=>{if("res"in t&&typeof t.res=="function"){let n=t,r=await n.compile(e,!0);return n.res(r,"server"),""}return await t.compile(e,!0)}}),b({name:"style",priority:1,children:!0,description:"Defines CSS styles for the component",example:"@style .button { background: blue; } @end",children_type:"css",onChildren:async(t,{children:e})=>{if("res"in t&&typeof t.res=="function"){let n=t,r=await n.compile(e,!0);return n.res(r,"css"),""}return""}}),b({name:"hydrate",priority:1,children:!0,description:"Marks content for client-side hydration",example:"@hydrate <button onclick='handleClick()'>Click</button> @end",onInit:t=>{if("res"in t&&typeof t.res=="function"){let e=t,n=`hydrate-${Math.random().toString(36).substring(7)}`;return e.res(`$ejb.res += '<div data-hydrate="${n}">';`,"server"),e.res(`document.querySelector('[data-hydrate="${n}"]').innerHTML = `,"client"),""}return"$ejb.res += '<div>';"},onEnd:t=>{if("res"in t&&typeof t.res=="function"){let e=t;return e.res("$ejb.res += '</div>';","server"),e.res(";","client"),""}return"$ejb.res += '</div>';"}}),b({name:"asset",priority:1,description:"Includes client-side assets (JS/CSS)",example:"@asset('script', 'main')",params:[{name:"type",type:"string",required:!0},{name:"name",type:"string",required:!0}],onParams:async(t,e)=>{if("getAssets"in t){let n=t,r=e.getString("type"),i=e.getString("name"),s=n.current;if(!s)throw new Error("[EJB] No current file set for @asset");let a=(await n.getAssets(s)).find(c=>r==="script"?c.startsWith("cl-")&&c.endsWith(".js"):r==="style"?c.startsWith("st-")&&c.endsWith(".css"):!1);if(a)return`$ejb.res += \`${r==="script"?`<script src="/${a}"></script>`:`<link rel="stylesheet" href="/${a}">`}\`;`}return""}}));var be=Object.assign({},fe,de,me,ge,he);var M=class{resolver;extension;globals;globalvar;aliases;root;globalexpose;errors=[];getFunction=()=>ue;directives={};async makeFunction(e){this.errors=[];let n=this.isTemplatePath(e),r=async i=>{let s=I(this,i);s.errors.length&&this.errors.push(...s.errors);let o=await Y(this,s);return(c=>this.errors.length>0?`return () => { const err = new Error('EJB compilation failed'); err.details = ${JSON.stringify(this.errors.map(p=>({message:p.stack||p.message,loc:p.loc})))}; throw err; }`:`
                return function(${this.globalvar}) {
                    const $ejb = {
                        ins: this,
                        res: '',
                        escapeHtml: ${W.toString()},
                        escapeJs: ${D.toString()},
                        EjbFunction: async function() { 
                            return new (async () => {}).constructor.apply(null, arguments);
                        }
                    };
                    
                    ${c}
                }.bind(this);
            `)(o)};if(n)try{let i=N(this,e),s=await Promise.resolve(this.resolver(i));return r(s)}catch(i){if(i&&typeof i=="object"&&"code"in i&&i.code==="ENOENT")return console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`),r(e);throw i}return r(e)}async compile(e,n=!1){let r=Array.isArray(e)?e:[e],i=n?K:J;return(await Promise.all(r.map(o=>i(this,o)))).join("")}parser(e){return I(this,e)}async render(e,n={}){if(this.errors=[],this.isTemplatePath(e))try{let c=N(this,e);e=await Promise.resolve(this.resolver(c))}catch(c){if(c&&typeof c=="object"&&"code"in c&&c.code==="ENOENT")console.warn(`[EJB] Template path resolution failed, using as literal: ${e}`);else throw c}let i=I(this,e);i.errors.length&&this.errors.push(...i.errors);let s=await Y(this,i),o=c=>new(this.getFunction())("$ejb",this.globalvar,c)({ins:this,res:"",escapeHtml:W,escapeJs:D,escapeString:ce,EjbFunction:this.getFunction()},{...this.globals,...n});if(this.errors.length>0){let c=this.errors.map(d=>d.stack||d.message).join(`

`);return this.errors=[],c}return(await o(s)).res}isTemplatePath(e){let n=e.trim();if(n.includes(`
`))return!1;let[r]=L.split("*");return n.includes(r)||new RegExp(`^s*${ae("@")}`).test(n)||se.test(n)?!1:n.includes("/")||n.includes("\\")||n.startsWith("@/")||n.startsWith("@\\")}register(...e){let n=e.map(r=>Object.keys(r).length===1?r:b(r));return this.directives=Object.assign(this.directives,...n),this}constructor(e={}){this.aliases=e.aliases??{},this.extension=e.extension??"ejb",this.globals=e.globals??{},this.root=e.root??"./",this.globalexpose=e.globalexpose??!0,this.resolver=e.resolver??(n=>{let r=`[EJB]: Resolver not defined, but was required for path: ${n}`;return Promise.reject(new Error(r))}),this.directives=Object.assign({},be,e.directives),this.globalvar=e?.globalvar??"it"}};var $e=class extends M{files={};_currentFile="";_currentLoader="server";dist;manifest;constructor(e={}){super(e),this.dist=e.dist??"./dist"}file(e){return this._currentFile=e,this.files[e]||(this.files[e]=[]),this}get current(){return this._currentFile}load(e){return this._currentLoader=e,this}get loader(){return this._currentLoader}res(e,n=this._currentLoader){if(!this._currentFile)throw new Error("[EJB] No file set. Call file() first.");let r=this.files[this._currentFile],i=r.find(s=>s.loader===n);i||(i={loader:n,content:""},r.push(i)),i.content+=e}async build(){let e={paths:{}};for(let[n,r]of Object.entries(this.files)){let i=[];for(let{loader:s,content:o}of r){let a=O(o).substring(0,8),c=s==="server"?"se":s==="client"?"cl":"st",d=s==="css"?"css":"js",p=n.split("/").pop()?.replace(/\.ejb$/,"")||"file",u=`${c}-${p}.${a}.${d}`;await ye(U(this.dist,u),o,"utf-8"),s==="server"?e.paths[n]={entry:u,assets:[]}:i.push(u)}e.paths[n]&&(e.paths[n].assets=i)}return await ye(U(this.dist,"ejb.json"),JSON.stringify(e,null,2),"utf-8"),this.manifest=e,e}async loadManifest(){if(this.manifest)return this.manifest;try{let e=await Ee(U(this.dist,"ejb.json"),"utf-8"),n=JSON.parse(e);return this.manifest=n,n}catch{throw new Error(`[EJB] Failed to load manifest from ${this.dist}/ejb.json`)}}async getEntry(e){return(await this.loadManifest()).paths[e]?.entry}async getAssets(e){return(await this.loadManifest()).paths[e]?.assets||[]}async renderBuilt(e,n={}){let r=await this.getEntry(e);if(!r)throw new Error(`[EJB] No entry found for ${e}`);let i=U(this.dist,r),s=await Ee(i,"utf-8");return(await new ve("$ejb",this.globalvar,s)({ins:this,res:"",escapeHtml:c=>c.replace(/[&<>"']/g,d=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[d]||d),escapeJs:c=>c.replace(/\\/g,"\\\\").replace(/`/g,"\\`").replace(/\$\{/g,"\\${"),EjbFunction:ve},{...this.globals,...n})).res}async compileFile(e){this.file(e);let n=await this.resolver(e),r=I(this,n);if(r.errors.length){this.errors.push(...r.errors);return}for(let i of["server","client","css"]){this.load(i);let s=await this.compile(r);this.res(s,i)}}},ve=Object.getPrototypeOf(async()=>{}).constructor;import{readFile as De}from"fs/promises";var At=()=>t=>De(t,{encoding:"utf-8"}),Ct=async t=>{try{let e=Bun.file(t);return await e.exists()?await e.text():""}catch(e){return console.error(`[EJB-IMPORT] Failed to resolve: ${t}`,e),""}};export{ue as AsyncFunction,G as DIRECTIVE_REGEX,Ct as EJBBunResolver,At as EJBNodeJSResolver,C as EJB_DEFAULT_PREFIX_DIRECTIVE,te as EJB_DEFAULT_PREFIX_GLOBAL,L as EJB_DEFAULT_PREFIX_VARIABLE,B as EJB_ESCAPED_PREFIX_DIRECTIVE,re as ESCAPE_HTML,ne as ESPACE_HTML_REGEX,M as Ejb,z as EjbAst,$e as EjbBuilder,se as HTML_REGULAR_REGEX,Y as compile,b as ejbDirective,I as ejbParser,W as escapeHtml,D as escapeJs,ae as escapeRegExp,ce as escapeString,N as filepathResolver,J as generateNodeCode,K as generateNodeString,le as join,O as md5,pe as returnEjbRes,Z as trimQuotes};
